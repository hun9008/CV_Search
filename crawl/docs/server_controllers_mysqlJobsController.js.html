<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>server/controllers/mysqlJobsController.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BaseWorkerManager.html">BaseWorkerManager</a><ul class='methods'><li data-type='method'><a href="BaseWorkerManager.html#closeBrowser">closeBrowser</a></li><li data-type='method'><a href="BaseWorkerManager.html#connect">connect</a></li><li data-type='method'><a href="BaseWorkerManager.html#disconnect">disconnect</a></li><li data-type='method'><a href="BaseWorkerManager.html#extractLinks">extractLinks</a></li><li data-type='method'><a href="BaseWorkerManager.html#extractPageContent">extractPageContent</a></li><li data-type='method'><a href="BaseWorkerManager.html#filterAllowedUrls">filterAllowedUrls</a></li><li data-type='method'><a href="BaseWorkerManager.html#getNextUrl">getNextUrl</a></li><li data-type='method'><a href="BaseWorkerManager.html#getUrlForDomain">getUrlForDomain</a></li><li data-type='method'><a href="BaseWorkerManager.html#groupUrlsByDomain">groupUrlsByDomain</a></li><li data-type='method'><a href="BaseWorkerManager.html#handleDomainError">handleDomainError</a></li><li data-type='method'><a href="BaseWorkerManager.html#initAvailableDomains">initAvailableDomains</a></li><li data-type='method'><a href="BaseWorkerManager.html#initBrowser">initBrowser</a></li><li data-type='method'><a href="BaseWorkerManager.html#processQueue">processQueue</a></li><li data-type='method'><a href="BaseWorkerManager.html#run">run</a></li><li data-type='method'><a href="BaseWorkerManager.html#saveErrorScreenshot">saveErrorScreenshot</a></li><li data-type='method'><a href="BaseWorkerManager.html#saveVisitResult">saveVisitResult</a></li><li data-type='method'><a href="BaseWorkerManager.html#selectTargetDomain">selectTargetDomain</a></li><li data-type='method'><a href="BaseWorkerManager.html#tryNextDomain">tryNextDomain</a></li><li data-type='method'><a href="BaseWorkerManager.html#visitUrl">visitUrl</a></li></ul></li><li><a href="ClaudeParser.html">ClaudeParser</a><ul class='methods'><li data-type='method'><a href="ClaudeParser.html#connect">connect</a></li><li data-type='method'><a href="ClaudeParser.html#convertToRecruitInfoSchema">convertToRecruitInfoSchema</a></li><li data-type='method'><a href="ClaudeParser.html#fetchRecruitUrls">fetchRecruitUrls</a></li><li data-type='method'><a href="ClaudeParser.html#processUrl">processUrl</a></li><li data-type='method'><a href="ClaudeParser.html#requestUrlParse">requestUrlParse</a></li><li data-type='method'><a href="ClaudeParser.html#run">run</a></li><li data-type='method'><a href="ClaudeParser.html#saveRecruitInfo">saveRecruitInfo</a></li><li data-type='method'><a href="ClaudeParser.html#wait">wait</a></li></ul></li><li><a href="ClaudeService.html">ClaudeService</a><ul class='methods'><li data-type='method'><a href="ClaudeService.html#generateContent">generateContent</a></li><li data-type='method'><a href="ClaudeService.html#getRecruitmentPrompt">getRecruitmentPrompt</a></li><li data-type='method'><a href="ClaudeService.html#getStatus">getStatus</a></li><li data-type='method'><a href="ClaudeService.html#initializeClient">initializeClient</a></li></ul></li><li><a href="GeminiService.html">GeminiService</a><ul class='methods'><li data-type='method'><a href="GeminiService.html#generateContent">generateContent</a></li><li data-type='method'><a href="GeminiService.html#getKeyStatus">getKeyStatus</a></li><li data-type='method'><a href="GeminiService.html#getRecruitmentPrompt">getRecruitmentPrompt</a></li><li data-type='method'><a href="GeminiService.html#getRecruitmentSchema">getRecruitmentSchema</a></li><li data-type='method'><a href="GeminiService.html#initializeClient">initializeClient</a></li><li data-type='method'><a href="GeminiService.html#parseRecruitment">parseRecruitment</a></li><li data-type='method'><a href="GeminiService.html#rotateApiKey">rotateApiKey</a></li></ul></li><li><a href="Logger.html">Logger</a><ul class='methods'><li data-type='method'><a href="Logger.html#checkLogFileDate">checkLogFileDate</a></li><li data-type='method'><a href="Logger.html#colorize">colorize</a></li><li data-type='method'><a href="Logger.html#formatJsonMessage">formatJsonMessage</a></li><li data-type='method'><a href="Logger.html#formatJsonMessage">formatJsonMessage</a></li><li data-type='method'><a href="Logger.html#formatTextMessage">formatTextMessage</a></li><li data-type='method'><a href="Logger.html#log">log</a></li><li data-type='method'><a href="Logger.html#logEvent">logEvent</a></li><li data-type='method'><a href="Logger.html#setupLogFiles">setupLogFiles</a></li><li data-type='method'><a href="Logger.html#setupLogRotation">setupLogRotation</a></li></ul></li><li><a href="MongoDBService.html">MongoDBService</a><ul class='methods'><li data-type='method'><a href="MongoDBService.html#connect">connect</a></li><li data-type='method'><a href="MongoDBService.html#disconnect">disconnect</a></li><li data-type='method'><a href="MongoDBService.html#getConnection">getConnection</a></li><li data-type='method'><a href="MongoDBService.html#getConnectionStatus">getConnectionStatus</a></li><li data-type='method'><a href="MongoDBService.html#getMongoose">getMongoose</a></li><li data-type='method'><a href="MongoDBService.html#setDbName">setDbName</a></li><li data-type='method'><a href="MongoDBService.html#setUri">setUri</a></li></ul></li><li><a href="OnClickWorker.html">OnClickWorker</a><ul class='methods'><li data-type='method'><a href="OnClickWorker.html#checkUrlChanges">checkUrlChanges</a></li><li data-type='method'><a href="OnClickWorker.html#cleanup">cleanup</a></li><li data-type='method'><a href="OnClickWorker.html#execute">execute</a></li><li data-type='method'><a href="OnClickWorker.html#formatResult">formatResult</a></li><li data-type='method'><a href="OnClickWorker.html#initialize">initialize</a></li><li data-type='method'><a href="OnClickWorker.html#scrollFullPage">scrollFullPage</a></li><li data-type='method'><a href="OnClickWorker.html#scrollPage">scrollPage</a></li><li data-type='method'><a href="OnClickWorker.html#setupPage">setupPage</a></li></ul></li><li><a href="ParseManager.html">ParseManager</a><ul class='methods'><li data-type='method'><a href="ParseManager.html#cancel">cancel</a></li><li data-type='method'><a href="ParseManager.html#connect">connect</a></li><li data-type='method'><a href="ParseManager.html#convertToRecruitInfoSchema">convertToRecruitInfoSchema</a></li><li data-type='method'><a href="ParseManager.html#fetchUnclassifiedUrls">fetchUnclassifiedUrls</a></li><li data-type='method'><a href="ParseManager.html#getStatus">getStatus</a></li><li data-type='method'><a href="ParseManager.html#processUrl">processUrl</a></li><li data-type='method'><a href="ParseManager.html#requestUrlParse">requestUrlParse</a></li><li data-type='method'><a href="ParseManager.html#run">run</a></li><li data-type='method'><a href="ParseManager.html#saveRecruitInfo">saveRecruitInfo</a></li><li data-type='method'><a href="ParseManager.html#wait">wait</a></li></ul></li><li><a href="RecruitInfoDbService.html">RecruitInfoDbService</a><ul class='methods'><li data-type='method'><a href="RecruitInfoDbService.html#bulkCreateOrUpdate">bulkCreateOrUpdate</a></li><li data-type='method'><a href="RecruitInfoDbService.html#bulkDelete">bulkDelete</a></li><li data-type='method'><a href="RecruitInfoDbService.html#createOrUpdate">createOrUpdate</a></li><li data-type='method'><a href="RecruitInfoDbService.html#deleteByUrl">deleteByUrl</a></li><li data-type='method'><a href="RecruitInfoDbService.html#deleteExpired">deleteExpired</a></li><li data-type='method'><a href="RecruitInfoDbService.html#getAll">getAll</a></li><li data-type='method'><a href="RecruitInfoDbService.html#getByUrl">getByUrl</a></li><li data-type='method'><a href="RecruitInfoDbService.html#getStats">getStats</a></li><li data-type='method'><a href="RecruitInfoDbService.html#search">search</a></li><li data-type='method'><a href="RecruitInfoDbService.html#searchByKeywords">searchByKeywords</a></li></ul></li><li><a href="WorkerPool.html">WorkerPool</a><ul class='methods'><li data-type='method'><a href="WorkerPool.html#enqueue">enqueue</a></li><li data-type='method'><a href="WorkerPool.html#processQueue">processQueue</a></li><li data-type='method'><a href="WorkerPool.html#processTasks">processTasks</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#RecruitInfo">RecruitInfo</a></li><li><a href="global.html#createTableIfNotExists">createTableIfNotExists</a></li><li><a href="global.html#extractAndExecuteScripts">extractAndExecuteScripts</a></li><li><a href="global.html#extractAndProcessOnClicks">extractAndProcessOnClicks</a></li><li><a href="global.html#extractDomain">extractDomain</a></li><li><a href="global.html#getClaudeJobById">getClaudeJobById</a></li><li><a href="global.html#getClaudeJobFilters">getClaudeJobFilters</a></li><li><a href="global.html#getClaudeJobStats">getClaudeJobStats</a></li><li><a href="global.html#getClaudeJobs">getClaudeJobs</a></li><li><a href="global.html#getCompleteClaudeJobs">getCompleteClaudeJobs</a></li><li><a href="global.html#getCompletionStats">getCompletionStats</a></li><li><a href="global.html#getDomainStats">getDomainStats</a></li><li><a href="global.html#getExperienceStats">getExperienceStats</a></li><li><a href="global.html#getFailedVisitStats">getFailedVisitStats</a></li><li><a href="global.html#getJobById">getJobById</a></li><li><a href="global.html#getJobTypeStats">getJobTypeStats</a></li><li><a href="global.html#getJobs">getJobs</a></li><li><a href="global.html#getMySqlJobFilters">getMySqlJobFilters</a></li><li><a href="global.html#getMySqlJobs">getMySqlJobs</a></li><li><a href="global.html#getResults">getResults</a></li><li><a href="global.html#getStats">getStats</a></li><li><a href="global.html#getUrlDetails">getUrlDetails</a></li><li><a href="global.html#getUrlSeed">getUrlSeed</a></li><li><a href="global.html#getUrlStats">getUrlStats</a></li><li><a href="global.html#handler">handler</a></li><li><a href="global.html#infiniteScroll">infiniteScroll</a></li><li><a href="global.html#isUrlAllowed">isUrlAllowed</a></li><li><a href="global.html#isUrlAllowedWithRobots">isUrlAllowedWithRobots</a></li><li><a href="global.html#logProgress">logProgress</a></li><li><a href="global.html#main">main</a></li><li><a href="global.html#parseRobotsTxt">parseRobotsTxt</a></li><li><a href="global.html#processOnClickEvents">processOnClickEvents</a></li><li><a href="global.html#processOnclick">processOnclick</a></li><li><a href="global.html#resetFailedVisitsForDomain">resetFailedVisitsForDomain</a></li><li><a href="global.html#resetVisitedStatus">resetVisitedStatus</a></li><li><a href="global.html#resetVisitedStatusForDomain">resetVisitedStatusForDomain</a></li><li><a href="global.html#runCrawler">runCrawler</a></li><li><a href="global.html#saveJobToMySql">saveJobToMySql</a></li><li><a href="global.html#saveSeedsToMongoDB">saveSeedsToMongoDB</a></li><li><a href="global.html#scrollToBottom">scrollToBottom</a></li><li><a href="global.html#updateVisitResultDomains">updateVisitResultDomains</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">server/controllers/mysqlJobsController.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const { mysqlService } = require('@database/mysql-service');
const { defaultLogger: logger } = require('@utils/logger');

/**
 * MySQL 채용공고 테이블 생성 (존재하지 않을 경우)
 */
const createTableIfNotExists = async () => {
  try {
    const sql = `
      CREATE TABLE IF NOT EXISTS jobs (
        id INT AUTO_INCREMENT PRIMARY KEY,
        title VARCHAR(255) NOT NULL,
        company_name VARCHAR(255) NOT NULL,
        job_type VARCHAR(100),
        experience VARCHAR(100),
        department VARCHAR(100),
        description TEXT,
        requirements TEXT,
        preferred_qualifications TEXT,
        ideal_candidate TEXT,
        url VARCHAR(500),
        posted_at DATETIME,
        end_date DATETIME,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
      )
    `;

    await mysqlService.query(sql);
    logger.info('MySQL jobs 테이블이 확인/생성되었습니다.');
  } catch (error) {
    logger.error('MySQL 테이블 생성 오류:', error);
    throw error;
  }
};

/**
 * 모든 MySQL 채용공고 조회
 * @param {Object} req - 요청 객체
 * @param {Object} res - 응답 객체
 */
exports.getMySqlJobs = async (req, res) => {
  try {
    await createTableIfNotExists();

    const {
      search = '',
      jobType = '',
      experience = '',
      sortBy = 'created_at',
      limit = 50,
      page = 1
    } = req.query;

    // 유효한 숫자로 변환
    const limitNum = parseInt(limit) || 50;
    const pageNum = parseInt(page) || 1;
    const offset = (pageNum - 1) * limitNum;

    // 기본 쿼리
    let sql = 'SELECT * FROM jobs WHERE 1=1';
    const params = [];

    // 검색 필터
    if (search) {
      sql += ' AND (title LIKE ? OR company_name LIKE ? OR description LIKE ?)';
      const searchParam = `%${search}%`;
      params.push(searchParam, searchParam, searchParam);
    }

    // 직무 유형 필터
    if (jobType) {
      sql += ' AND job_type LIKE ?';
      params.push(`%${jobType}%`);
    }

    // 경력 필터
    if (experience) {
      sql += ' AND experience LIKE ?';
      params.push(`%${experience}%`);
    }

    // 정렬
    sql += ` ORDER BY ${sortBy === 'created_at' ? 'created_at DESC' :
             sortBy === 'company_name' ? 'company_name ASC' :
             sortBy === 'job_type' ? 'job_type ASC' : 'created_at DESC'}`;

    // 페이징
    sql += ' LIMIT ? OFFSET ?';
    params.push(limitNum, offset);

    // 쿼리 실행
    const jobs = await mysqlService.query(sql, params);

    // 총 결과 수 카운트
    let countSql = 'SELECT COUNT(*) as total FROM jobs WHERE 1=1';
    const countParams = [];

    if (search) {
      countSql += ' AND (title LIKE ? OR company_name LIKE ? OR description LIKE ?)';
      const searchParam = `%${search}%`;
      countParams.push(searchParam, searchParam, searchParam);
    }

    if (jobType) {
      countSql += ' AND job_type LIKE ?';
      countParams.push(`%${jobType}%`);
    }

    if (experience) {
      countSql += ' AND experience LIKE ?';
      countParams.push(`%${experience}%`);
    }

    const countResult = await mysqlService.query(countSql, countParams);
    const total = countResult[0].total;

    // 응답
    res.status(200).json({
      success: true,
      total,
      page: pageNum,
      limit: limitNum,
      pages: Math.ceil(total / limitNum),
      jobs
    });
  } catch (error) {
    logger.error('MySQL 채용정보 조회 오류:', error);
    res.status(500).json({
      success: false,
      error: 'MySQL 채용정보를 조회하는 중 오류가 발생했습니다.'
    });
  }
};

/**
 * MySQL에 채용공고 저장
 * @param {Object} req - 요청 객체
 * @param {Object} res - 응답 객체
 */
exports.saveJobToMySql = async (req, res) => {
  try {
    await createTableIfNotExists();

    const {
      title,
      company_name,
      job_type,
      experience,
      department,
      description,
      requirements,
      preferred_qualifications,
      ideal_candidate,
      url,
      posted_at,
      end_date
    } = req.body;

    // 필수 필드 검증
    if (!title || !company_name) {
      return res.status(400).json({
        success: false,
        error: '제목과 회사명은 필수 항목입니다.'
      });
    }

    const sql = `
      INSERT INTO jobs (
        title, company_name, job_type, experience, department,
        description, requirements, preferred_qualifications,
        ideal_candidate, url, posted_at, end_date
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `;

    const params = [
      title, company_name, job_type || null, experience || null, department || null,
      description || null, requirements || null, preferred_qualifications || null,
      ideal_candidate || null, url || null,
      posted_at ? new Date(posted_at) : null,
      end_date ? new Date(end_date) : null
    ];

    const result = await mysqlService.query(sql, params);

    res.status(201).json({
      success: true,
      message: '채용공고가 MySQL에 저장되었습니다.',
      id: result.insertId
    });
  } catch (error) {
    logger.error('MySQL 채용정보 저장 오류:', error);
    res.status(500).json({
      success: false,
      error: 'MySQL에 채용정보를 저장하는 중 오류가 발생했습니다.'
    });
  }
};

/**
 * MySQL 채용공고 필터 옵션 조회
 * @param {Object} req - 요청 객체
 * @param {Object} res - 응답 객체
 */
exports.getMySqlJobFilters = async (req, res) => {
  try {
    await createTableIfNotExists();

    // 직무 유형 조회
    const jobTypesSql = 'SELECT DISTINCT job_type FROM jobs WHERE job_type IS NOT NULL';
    const jobTypes = await mysqlService.query(jobTypesSql);

    // 경력 레벨 조회
    const experienceSql = 'SELECT DISTINCT experience FROM jobs WHERE experience IS NOT NULL';
    const experienceLevels = await mysqlService.query(experienceSql);

    res.status(200).json({
      success: true,
      jobTypes: jobTypes.map(item => item.job_type).filter(Boolean),
      experienceLevels: experienceLevels.map(item => item.experience).filter(Boolean)
    });
  } catch (error) {
    logger.error('MySQL 채용정보 필터 옵션 조회 오류:', error);
    res.status(500).json({
      success: false,
      error: 'MySQL 채용정보 필터 옵션을 조회하는 중 오류가 발생했습니다.'
    });
  }
};

module.exports = exports;</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.4</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
