<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>index.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BaseWorkerManager.html">BaseWorkerManager</a><ul class='methods'><li data-type='method'><a href="BaseWorkerManager.html#closeBrowser">closeBrowser</a></li><li data-type='method'><a href="BaseWorkerManager.html#connect">connect</a></li><li data-type='method'><a href="BaseWorkerManager.html#disconnect">disconnect</a></li><li data-type='method'><a href="BaseWorkerManager.html#extractLinks">extractLinks</a></li><li data-type='method'><a href="BaseWorkerManager.html#extractPageContent">extractPageContent</a></li><li data-type='method'><a href="BaseWorkerManager.html#filterAllowedUrls">filterAllowedUrls</a></li><li data-type='method'><a href="BaseWorkerManager.html#getNextUrl">getNextUrl</a></li><li data-type='method'><a href="BaseWorkerManager.html#getUrlForDomain">getUrlForDomain</a></li><li data-type='method'><a href="BaseWorkerManager.html#groupUrlsByDomain">groupUrlsByDomain</a></li><li data-type='method'><a href="BaseWorkerManager.html#handleDomainError">handleDomainError</a></li><li data-type='method'><a href="BaseWorkerManager.html#initAvailableDomains">initAvailableDomains</a></li><li data-type='method'><a href="BaseWorkerManager.html#initBrowser">initBrowser</a></li><li data-type='method'><a href="BaseWorkerManager.html#processQueue">processQueue</a></li><li data-type='method'><a href="BaseWorkerManager.html#run">run</a></li><li data-type='method'><a href="BaseWorkerManager.html#saveErrorScreenshot">saveErrorScreenshot</a></li><li data-type='method'><a href="BaseWorkerManager.html#saveVisitResult">saveVisitResult</a></li><li data-type='method'><a href="BaseWorkerManager.html#selectTargetDomain">selectTargetDomain</a></li><li data-type='method'><a href="BaseWorkerManager.html#tryNextDomain">tryNextDomain</a></li><li data-type='method'><a href="BaseWorkerManager.html#visitUrl">visitUrl</a></li></ul></li><li><a href="ClaudeParser.html">ClaudeParser</a><ul class='methods'><li data-type='method'><a href="ClaudeParser.html#connect">connect</a></li><li data-type='method'><a href="ClaudeParser.html#convertToRecruitInfoSchema">convertToRecruitInfoSchema</a></li><li data-type='method'><a href="ClaudeParser.html#fetchRecruitUrls">fetchRecruitUrls</a></li><li data-type='method'><a href="ClaudeParser.html#processUrl">processUrl</a></li><li data-type='method'><a href="ClaudeParser.html#requestUrlParse">requestUrlParse</a></li><li data-type='method'><a href="ClaudeParser.html#run">run</a></li><li data-type='method'><a href="ClaudeParser.html#saveRecruitInfo">saveRecruitInfo</a></li><li data-type='method'><a href="ClaudeParser.html#wait">wait</a></li></ul></li><li><a href="ClaudeService.html">ClaudeService</a><ul class='methods'><li data-type='method'><a href="ClaudeService.html#generateContent">generateContent</a></li><li data-type='method'><a href="ClaudeService.html#getRecruitmentPrompt">getRecruitmentPrompt</a></li><li data-type='method'><a href="ClaudeService.html#getStatus">getStatus</a></li><li data-type='method'><a href="ClaudeService.html#initializeClient">initializeClient</a></li></ul></li><li><a href="GeminiService.html">GeminiService</a><ul class='methods'><li data-type='method'><a href="GeminiService.html#generateContent">generateContent</a></li><li data-type='method'><a href="GeminiService.html#getKeyStatus">getKeyStatus</a></li><li data-type='method'><a href="GeminiService.html#getRecruitmentPrompt">getRecruitmentPrompt</a></li><li data-type='method'><a href="GeminiService.html#getRecruitmentSchema">getRecruitmentSchema</a></li><li data-type='method'><a href="GeminiService.html#initializeClient">initializeClient</a></li><li data-type='method'><a href="GeminiService.html#parseRecruitment">parseRecruitment</a></li><li data-type='method'><a href="GeminiService.html#rotateApiKey">rotateApiKey</a></li></ul></li><li><a href="Logger.html">Logger</a><ul class='methods'><li data-type='method'><a href="Logger.html#checkLogFileDate">checkLogFileDate</a></li><li data-type='method'><a href="Logger.html#colorize">colorize</a></li><li data-type='method'><a href="Logger.html#formatJsonMessage">formatJsonMessage</a></li><li data-type='method'><a href="Logger.html#formatJsonMessage">formatJsonMessage</a></li><li data-type='method'><a href="Logger.html#formatTextMessage">formatTextMessage</a></li><li data-type='method'><a href="Logger.html#log">log</a></li><li data-type='method'><a href="Logger.html#logEvent">logEvent</a></li><li data-type='method'><a href="Logger.html#setupLogFiles">setupLogFiles</a></li><li data-type='method'><a href="Logger.html#setupLogRotation">setupLogRotation</a></li></ul></li><li><a href="MongoDBService.html">MongoDBService</a><ul class='methods'><li data-type='method'><a href="MongoDBService.html#connect">connect</a></li><li data-type='method'><a href="MongoDBService.html#disconnect">disconnect</a></li><li data-type='method'><a href="MongoDBService.html#getConnection">getConnection</a></li><li data-type='method'><a href="MongoDBService.html#getConnectionStatus">getConnectionStatus</a></li><li data-type='method'><a href="MongoDBService.html#getMongoose">getMongoose</a></li><li data-type='method'><a href="MongoDBService.html#setDbName">setDbName</a></li><li data-type='method'><a href="MongoDBService.html#setUri">setUri</a></li></ul></li><li><a href="OnClickWorker.html">OnClickWorker</a><ul class='methods'><li data-type='method'><a href="OnClickWorker.html#checkUrlChanges">checkUrlChanges</a></li><li data-type='method'><a href="OnClickWorker.html#cleanup">cleanup</a></li><li data-type='method'><a href="OnClickWorker.html#execute">execute</a></li><li data-type='method'><a href="OnClickWorker.html#formatResult">formatResult</a></li><li data-type='method'><a href="OnClickWorker.html#initialize">initialize</a></li><li data-type='method'><a href="OnClickWorker.html#scrollFullPage">scrollFullPage</a></li><li data-type='method'><a href="OnClickWorker.html#scrollPage">scrollPage</a></li><li data-type='method'><a href="OnClickWorker.html#setupPage">setupPage</a></li></ul></li><li><a href="ParseManager.html">ParseManager</a><ul class='methods'><li data-type='method'><a href="ParseManager.html#cancel">cancel</a></li><li data-type='method'><a href="ParseManager.html#connect">connect</a></li><li data-type='method'><a href="ParseManager.html#convertToRecruitInfoSchema">convertToRecruitInfoSchema</a></li><li data-type='method'><a href="ParseManager.html#fetchUnclassifiedUrls">fetchUnclassifiedUrls</a></li><li data-type='method'><a href="ParseManager.html#getStatus">getStatus</a></li><li data-type='method'><a href="ParseManager.html#processUrl">processUrl</a></li><li data-type='method'><a href="ParseManager.html#requestUrlParse">requestUrlParse</a></li><li data-type='method'><a href="ParseManager.html#run">run</a></li><li data-type='method'><a href="ParseManager.html#saveRecruitInfo">saveRecruitInfo</a></li><li data-type='method'><a href="ParseManager.html#wait">wait</a></li></ul></li><li><a href="RecruitInfoDbService.html">RecruitInfoDbService</a><ul class='methods'><li data-type='method'><a href="RecruitInfoDbService.html#bulkCreateOrUpdate">bulkCreateOrUpdate</a></li><li data-type='method'><a href="RecruitInfoDbService.html#bulkDelete">bulkDelete</a></li><li data-type='method'><a href="RecruitInfoDbService.html#createOrUpdate">createOrUpdate</a></li><li data-type='method'><a href="RecruitInfoDbService.html#deleteByUrl">deleteByUrl</a></li><li data-type='method'><a href="RecruitInfoDbService.html#deleteExpired">deleteExpired</a></li><li data-type='method'><a href="RecruitInfoDbService.html#getAll">getAll</a></li><li data-type='method'><a href="RecruitInfoDbService.html#getByUrl">getByUrl</a></li><li data-type='method'><a href="RecruitInfoDbService.html#getStats">getStats</a></li><li data-type='method'><a href="RecruitInfoDbService.html#search">search</a></li><li data-type='method'><a href="RecruitInfoDbService.html#searchByKeywords">searchByKeywords</a></li></ul></li><li><a href="WorkerPool.html">WorkerPool</a><ul class='methods'><li data-type='method'><a href="WorkerPool.html#enqueue">enqueue</a></li><li data-type='method'><a href="WorkerPool.html#processQueue">processQueue</a></li><li data-type='method'><a href="WorkerPool.html#processTasks">processTasks</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#RecruitInfo">RecruitInfo</a></li><li><a href="global.html#createTableIfNotExists">createTableIfNotExists</a></li><li><a href="global.html#extractAndExecuteScripts">extractAndExecuteScripts</a></li><li><a href="global.html#extractAndProcessOnClicks">extractAndProcessOnClicks</a></li><li><a href="global.html#extractDomain">extractDomain</a></li><li><a href="global.html#getClaudeJobById">getClaudeJobById</a></li><li><a href="global.html#getClaudeJobFilters">getClaudeJobFilters</a></li><li><a href="global.html#getClaudeJobStats">getClaudeJobStats</a></li><li><a href="global.html#getClaudeJobs">getClaudeJobs</a></li><li><a href="global.html#getCompleteClaudeJobs">getCompleteClaudeJobs</a></li><li><a href="global.html#getCompletionStats">getCompletionStats</a></li><li><a href="global.html#getDomainStats">getDomainStats</a></li><li><a href="global.html#getExperienceStats">getExperienceStats</a></li><li><a href="global.html#getFailedVisitStats">getFailedVisitStats</a></li><li><a href="global.html#getJobById">getJobById</a></li><li><a href="global.html#getJobTypeStats">getJobTypeStats</a></li><li><a href="global.html#getJobs">getJobs</a></li><li><a href="global.html#getMySqlJobFilters">getMySqlJobFilters</a></li><li><a href="global.html#getMySqlJobs">getMySqlJobs</a></li><li><a href="global.html#getResults">getResults</a></li><li><a href="global.html#getStats">getStats</a></li><li><a href="global.html#getUrlDetails">getUrlDetails</a></li><li><a href="global.html#getUrlSeed">getUrlSeed</a></li><li><a href="global.html#getUrlStats">getUrlStats</a></li><li><a href="global.html#handler">handler</a></li><li><a href="global.html#infiniteScroll">infiniteScroll</a></li><li><a href="global.html#isUrlAllowed">isUrlAllowed</a></li><li><a href="global.html#isUrlAllowedWithRobots">isUrlAllowedWithRobots</a></li><li><a href="global.html#logProgress">logProgress</a></li><li><a href="global.html#main">main</a></li><li><a href="global.html#parseRobotsTxt">parseRobotsTxt</a></li><li><a href="global.html#processOnClickEvents">processOnClickEvents</a></li><li><a href="global.html#processOnclick">processOnclick</a></li><li><a href="global.html#resetFailedVisitsForDomain">resetFailedVisitsForDomain</a></li><li><a href="global.html#resetVisitedStatus">resetVisitedStatus</a></li><li><a href="global.html#resetVisitedStatusForDomain">resetVisitedStatusForDomain</a></li><li><a href="global.html#runCrawler">runCrawler</a></li><li><a href="global.html#saveJobToMySql">saveJobToMySql</a></li><li><a href="global.html#saveSeedsToMongoDB">saveSeedsToMongoDB</a></li><li><a href="global.html#scrollToBottom">scrollToBottom</a></li><li><a href="global.html#updateVisitResultDomains">updateVisitResultDomains</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

require('module-alias/register');
const chromium = require('chrome-aws-lambda');
const { BaseWorkerManager } = require('@crawl/baseWorkerManager');
const { defaultLogger: logger } = require('@utils/logger');
const { mongoService } = require('@database/mongodb-service');
const CONFIG = require('@config/config');

/**
 * 크롤링 작업 실행 함수
 * @param {Object} event - Lambda 이벤트 객체
 * @param {Object} context - Lambda 컨텍스트 객체
 * @returns {Promise&lt;Object>} 작업 결과
 */
async function runCrawler(event, context) {
  let browser = null;
  let manager = null;
  let connectionEstablished = false;

  try {
    logger.info('Lambda 함수 시작');
    logger.info('이벤트 데이터:', JSON.stringify(event, null, 2));

    // 남은 실행 시간 확인
    const remainingTime = context.getRemainingTimeInMillis();
    logger.info(`남은 실행 시간: ${remainingTime}ms`);

    // 최대 URL 수 계산 (Lambda 타임아웃 고려)
    const maxTime = process.env.MAX_EXECUTION_TIME || 840000; // 기본 14분 (Lambda 최대 15분)
    const timePerUrl = process.env.TIME_PER_URL || 10000; // URL당 평균 10초
    const calculatedMaxUrls = Math.floor(Math.min(remainingTime - 60000, maxTime) / timePerUrl);

    // 설정된 최대 URL 수와 계산된 값 중 작은 값 사용
    const maxUrls = Math.min(
      calculatedMaxUrls,
      CONFIG.CRAWLER.MAX_URLS || 500,
      event.maxUrls || Number.MAX_SAFE_INTEGER
    );

    logger.info(`설정된 최대 URL 수: ${maxUrls}`);

    // MongoDB 연결
    await mongoService.connect();
    connectionEstablished = true;
    logger.info('MongoDB 연결 성공');

    // 브라우저 실행 옵션
    const executablePath = await chromium.executablePath;

    // 브라우저 인스턴스 생성
    browser = await chromium.puppeteer.launch({
      args: chromium.args,
      defaultViewport: chromium.defaultViewport,
      executablePath,
      headless: chromium.headless,
      ignoreHTTPSErrors: true
    });

    logger.info('Puppeteer 브라우저 인스턴스 생성 완료');

    // 이벤트에서 설정 가져오기
    const options = {
      browser,
      headless: true,
      delayBetweenRequests: event.delayBetweenRequests || CONFIG.CRAWLER.DELAY_BETWEEN_REQUESTS,
      maxUrls,
      startUrl: event.startUrl,
      strategy: event.strategy || 'bfs',
      specificDomain: event.specificDomain,
      maxConcurrency: event.maxConcurrency || 2, // Lambda에서는 병렬 작업 제한
      timeoutPerPage: event.timeoutPerPage || 30000,
      restartBrowser: false, // Lambda에서는 브라우저 재시작 비활성화
      lambdaMode: true // Lambda 환경 표시
    };

    // 필수 파라미터 검증
    if (!options.startUrl) {
      throw new Error('시작 URL(startUrl)이 제공되지 않았습니다.');
    }

    logger.info('크롤러 설정:', options);

    // BaseWorkerManager 인스턴스 생성
    manager = new BaseWorkerManager(options);

    // AWS Lambda 제한 시간 고려하여 타임아웃 설정
    const timeoutId = setTimeout(() => {
      logger.warn(`최대 실행 시간(${maxTime}ms)에 도달하여 작업을 중단합니다.`);
      manager.stop(); // 작업 중단 메서드 (BaseWorkerManager에 구현 필요)
    }, maxTime);

    // 크롤링 실행
    const result = await manager.run();

    // 타임아웃 취소
    clearTimeout(timeoutId);

    // 결과 요약
    const summary = {
      startUrl: options.startUrl,
      domain: options.specificDomain,
      strategy: options.strategy,
      urlsProcessed: result?.urlsProcessed || 0,
      urlsDiscovered: result?.urlsDiscovered || 0,
      success: true,
      executionTimeMs: context.getRemainingTimeInMillis() ?
                       remainingTime - context.getRemainingTimeInMillis() :
                       'unknown'
    };

    logger.info('크롤링 완료, 결과 요약:', summary);
    return {
      statusCode: 200,
      body: JSON.stringify(summary)
    };

  } catch (error) {
    logger.error('크롤링 작업 중 오류 발생:', error);

    return {
      statusCode: 500,
      body: JSON.stringify({
        message: `오류 발생: ${error.message}`,
        stack: process.env.NODE_ENV === 'development' ? error.stack : undefined
      })
    };
  } finally {
    // 리소스 정리
    try {
      if (manager) {
        // 관리자 종료 로직 (구현 필요)
        logger.info('BaseWorkerManager 종료 중...');
        // manager.cleanup(); // 이 메서드가 구현되어 있다면 호출
      }

      if (browser) {
        logger.info('브라우저 인스턴스 종료 중...');
        await browser.close();
      }

      if (connectionEstablished) {
        logger.info('MongoDB 연결 종료 중...');
        await mongoService.disconnect();
      }
    } catch (cleanupError) {
      logger.error('리소스 정리 중 오류:', cleanupError);
    }

    logger.info('Lambda 함수 종료');
  }
}

/**
 * Lambda 핸들러 함수
 */
exports.handler = async (event, context) => {
  // 콜드 스타트 감지
  const isColdStart = !global.lambdaWarmUp;
  global.lambdaWarmUp = true;

  if (isColdStart) {
    logger.info('Lambda 콜드 스타트 감지');
  }

  // "ping" 이벤트는 웜업 요청으로 처리
  if (event.ping) {
    logger.info('웜업 요청 수신');
    return {
      statusCode: 200,
      body: JSON.stringify({ message: 'Lambda 함수가 준비되었습니다.' })
    };
  }

  return runCrawler(event, context);
};

// 로컬 실행을 위한 코드
if (require.main === module) {
  // 로컬 실행 환경에서 테스트를 위한 설정
  const testEvent = {
    startUrl: process.argv[2] || 'https://example.com',
    specificDomain: process.argv[3] || 'example.com',
    strategy: process.argv[4] || 'specific',
    maxUrls: parseInt(process.argv[5] || '50', 10),
    delayBetweenRequests: 1000
  };

  logger.info('로컬 환경에서 실행 중...');
  logger.info('테스트 이벤트:', testEvent);

  // 가상의 Lambda 컨텍스트 생성
  const mockContext = {
    getRemainingTimeInMillis: () => 900000, // 15분
    functionName: 'localRun',
    functionVersion: 'local',
    invokedFunctionArn: 'local:function',
    memoryLimitInMB: '2048',
    awsRequestId: 'local-' + Date.now(),
    logGroupName: '/local/crawler',
    logStreamName: `local/${Date.now()}`
  };

  // Lambda 핸들러 함수 실행
  exports.handler(testEvent, mockContext)
    .then(result => {
      logger.info('실행 결과:', result);
      process.exit(0);
    })
    .catch(error => {
      logger.error('실행 중 오류 발생:', error);
      process.exit(1);
    });
}

</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.4</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
