<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>scripts/resetFailedVisits.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BaseWorkerManager.html">BaseWorkerManager</a><ul class='methods'><li data-type='method'><a href="BaseWorkerManager.html#closeBrowser">closeBrowser</a></li><li data-type='method'><a href="BaseWorkerManager.html#connect">connect</a></li><li data-type='method'><a href="BaseWorkerManager.html#disconnect">disconnect</a></li><li data-type='method'><a href="BaseWorkerManager.html#extractLinks">extractLinks</a></li><li data-type='method'><a href="BaseWorkerManager.html#extractPageContent">extractPageContent</a></li><li data-type='method'><a href="BaseWorkerManager.html#filterAllowedUrls">filterAllowedUrls</a></li><li data-type='method'><a href="BaseWorkerManager.html#getNextUrl">getNextUrl</a></li><li data-type='method'><a href="BaseWorkerManager.html#getUrlForDomain">getUrlForDomain</a></li><li data-type='method'><a href="BaseWorkerManager.html#groupUrlsByDomain">groupUrlsByDomain</a></li><li data-type='method'><a href="BaseWorkerManager.html#handleDomainError">handleDomainError</a></li><li data-type='method'><a href="BaseWorkerManager.html#initAvailableDomains">initAvailableDomains</a></li><li data-type='method'><a href="BaseWorkerManager.html#initBrowser">initBrowser</a></li><li data-type='method'><a href="BaseWorkerManager.html#processQueue">processQueue</a></li><li data-type='method'><a href="BaseWorkerManager.html#run">run</a></li><li data-type='method'><a href="BaseWorkerManager.html#saveErrorScreenshot">saveErrorScreenshot</a></li><li data-type='method'><a href="BaseWorkerManager.html#saveVisitResult">saveVisitResult</a></li><li data-type='method'><a href="BaseWorkerManager.html#selectTargetDomain">selectTargetDomain</a></li><li data-type='method'><a href="BaseWorkerManager.html#tryNextDomain">tryNextDomain</a></li><li data-type='method'><a href="BaseWorkerManager.html#visitUrl">visitUrl</a></li></ul></li><li><a href="ClaudeParser.html">ClaudeParser</a><ul class='methods'><li data-type='method'><a href="ClaudeParser.html#connect">connect</a></li><li data-type='method'><a href="ClaudeParser.html#convertToRecruitInfoSchema">convertToRecruitInfoSchema</a></li><li data-type='method'><a href="ClaudeParser.html#fetchRecruitUrls">fetchRecruitUrls</a></li><li data-type='method'><a href="ClaudeParser.html#processUrl">processUrl</a></li><li data-type='method'><a href="ClaudeParser.html#requestUrlParse">requestUrlParse</a></li><li data-type='method'><a href="ClaudeParser.html#run">run</a></li><li data-type='method'><a href="ClaudeParser.html#saveRecruitInfo">saveRecruitInfo</a></li><li data-type='method'><a href="ClaudeParser.html#wait">wait</a></li></ul></li><li><a href="ClaudeService.html">ClaudeService</a><ul class='methods'><li data-type='method'><a href="ClaudeService.html#generateContent">generateContent</a></li><li data-type='method'><a href="ClaudeService.html#getRecruitmentPrompt">getRecruitmentPrompt</a></li><li data-type='method'><a href="ClaudeService.html#getStatus">getStatus</a></li><li data-type='method'><a href="ClaudeService.html#initializeClient">initializeClient</a></li></ul></li><li><a href="GeminiService.html">GeminiService</a><ul class='methods'><li data-type='method'><a href="GeminiService.html#generateContent">generateContent</a></li><li data-type='method'><a href="GeminiService.html#getKeyStatus">getKeyStatus</a></li><li data-type='method'><a href="GeminiService.html#getRecruitmentPrompt">getRecruitmentPrompt</a></li><li data-type='method'><a href="GeminiService.html#getRecruitmentSchema">getRecruitmentSchema</a></li><li data-type='method'><a href="GeminiService.html#initializeClient">initializeClient</a></li><li data-type='method'><a href="GeminiService.html#parseRecruitment">parseRecruitment</a></li><li data-type='method'><a href="GeminiService.html#rotateApiKey">rotateApiKey</a></li></ul></li><li><a href="Logger.html">Logger</a><ul class='methods'><li data-type='method'><a href="Logger.html#checkLogFileDate">checkLogFileDate</a></li><li data-type='method'><a href="Logger.html#colorize">colorize</a></li><li data-type='method'><a href="Logger.html#formatJsonMessage">formatJsonMessage</a></li><li data-type='method'><a href="Logger.html#formatJsonMessage">formatJsonMessage</a></li><li data-type='method'><a href="Logger.html#formatTextMessage">formatTextMessage</a></li><li data-type='method'><a href="Logger.html#log">log</a></li><li data-type='method'><a href="Logger.html#logEvent">logEvent</a></li><li data-type='method'><a href="Logger.html#setupLogFiles">setupLogFiles</a></li><li data-type='method'><a href="Logger.html#setupLogRotation">setupLogRotation</a></li></ul></li><li><a href="MongoDBService.html">MongoDBService</a><ul class='methods'><li data-type='method'><a href="MongoDBService.html#connect">connect</a></li><li data-type='method'><a href="MongoDBService.html#disconnect">disconnect</a></li><li data-type='method'><a href="MongoDBService.html#getConnection">getConnection</a></li><li data-type='method'><a href="MongoDBService.html#getConnectionStatus">getConnectionStatus</a></li><li data-type='method'><a href="MongoDBService.html#getMongoose">getMongoose</a></li><li data-type='method'><a href="MongoDBService.html#setDbName">setDbName</a></li><li data-type='method'><a href="MongoDBService.html#setUri">setUri</a></li></ul></li><li><a href="OnClickWorker.html">OnClickWorker</a><ul class='methods'><li data-type='method'><a href="OnClickWorker.html#checkUrlChanges">checkUrlChanges</a></li><li data-type='method'><a href="OnClickWorker.html#cleanup">cleanup</a></li><li data-type='method'><a href="OnClickWorker.html#execute">execute</a></li><li data-type='method'><a href="OnClickWorker.html#formatResult">formatResult</a></li><li data-type='method'><a href="OnClickWorker.html#initialize">initialize</a></li><li data-type='method'><a href="OnClickWorker.html#scrollFullPage">scrollFullPage</a></li><li data-type='method'><a href="OnClickWorker.html#scrollPage">scrollPage</a></li><li data-type='method'><a href="OnClickWorker.html#setupPage">setupPage</a></li></ul></li><li><a href="ParseManager.html">ParseManager</a><ul class='methods'><li data-type='method'><a href="ParseManager.html#cancel">cancel</a></li><li data-type='method'><a href="ParseManager.html#connect">connect</a></li><li data-type='method'><a href="ParseManager.html#convertToRecruitInfoSchema">convertToRecruitInfoSchema</a></li><li data-type='method'><a href="ParseManager.html#fetchUnclassifiedUrls">fetchUnclassifiedUrls</a></li><li data-type='method'><a href="ParseManager.html#getStatus">getStatus</a></li><li data-type='method'><a href="ParseManager.html#processUrl">processUrl</a></li><li data-type='method'><a href="ParseManager.html#requestUrlParse">requestUrlParse</a></li><li data-type='method'><a href="ParseManager.html#run">run</a></li><li data-type='method'><a href="ParseManager.html#saveRecruitInfo">saveRecruitInfo</a></li><li data-type='method'><a href="ParseManager.html#wait">wait</a></li></ul></li><li><a href="RecruitInfoDbService.html">RecruitInfoDbService</a><ul class='methods'><li data-type='method'><a href="RecruitInfoDbService.html#bulkCreateOrUpdate">bulkCreateOrUpdate</a></li><li data-type='method'><a href="RecruitInfoDbService.html#bulkDelete">bulkDelete</a></li><li data-type='method'><a href="RecruitInfoDbService.html#createOrUpdate">createOrUpdate</a></li><li data-type='method'><a href="RecruitInfoDbService.html#deleteByUrl">deleteByUrl</a></li><li data-type='method'><a href="RecruitInfoDbService.html#deleteExpired">deleteExpired</a></li><li data-type='method'><a href="RecruitInfoDbService.html#getAll">getAll</a></li><li data-type='method'><a href="RecruitInfoDbService.html#getByUrl">getByUrl</a></li><li data-type='method'><a href="RecruitInfoDbService.html#getStats">getStats</a></li><li data-type='method'><a href="RecruitInfoDbService.html#search">search</a></li><li data-type='method'><a href="RecruitInfoDbService.html#searchByKeywords">searchByKeywords</a></li></ul></li><li><a href="WorkerPool.html">WorkerPool</a><ul class='methods'><li data-type='method'><a href="WorkerPool.html#enqueue">enqueue</a></li><li data-type='method'><a href="WorkerPool.html#processQueue">processQueue</a></li><li data-type='method'><a href="WorkerPool.html#processTasks">processTasks</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#RecruitInfo">RecruitInfo</a></li><li><a href="global.html#createTableIfNotExists">createTableIfNotExists</a></li><li><a href="global.html#extractAndExecuteScripts">extractAndExecuteScripts</a></li><li><a href="global.html#extractAndProcessOnClicks">extractAndProcessOnClicks</a></li><li><a href="global.html#extractDomain">extractDomain</a></li><li><a href="global.html#getClaudeJobById">getClaudeJobById</a></li><li><a href="global.html#getClaudeJobFilters">getClaudeJobFilters</a></li><li><a href="global.html#getClaudeJobStats">getClaudeJobStats</a></li><li><a href="global.html#getClaudeJobs">getClaudeJobs</a></li><li><a href="global.html#getCompleteClaudeJobs">getCompleteClaudeJobs</a></li><li><a href="global.html#getCompletionStats">getCompletionStats</a></li><li><a href="global.html#getDomainStats">getDomainStats</a></li><li><a href="global.html#getExperienceStats">getExperienceStats</a></li><li><a href="global.html#getFailedVisitStats">getFailedVisitStats</a></li><li><a href="global.html#getJobById">getJobById</a></li><li><a href="global.html#getJobTypeStats">getJobTypeStats</a></li><li><a href="global.html#getJobs">getJobs</a></li><li><a href="global.html#getMySqlJobFilters">getMySqlJobFilters</a></li><li><a href="global.html#getMySqlJobs">getMySqlJobs</a></li><li><a href="global.html#getResults">getResults</a></li><li><a href="global.html#getStats">getStats</a></li><li><a href="global.html#getUrlDetails">getUrlDetails</a></li><li><a href="global.html#getUrlSeed">getUrlSeed</a></li><li><a href="global.html#getUrlStats">getUrlStats</a></li><li><a href="global.html#handler">handler</a></li><li><a href="global.html#infiniteScroll">infiniteScroll</a></li><li><a href="global.html#isUrlAllowed">isUrlAllowed</a></li><li><a href="global.html#isUrlAllowedWithRobots">isUrlAllowedWithRobots</a></li><li><a href="global.html#logProgress">logProgress</a></li><li><a href="global.html#main">main</a></li><li><a href="global.html#parseRobotsTxt">parseRobotsTxt</a></li><li><a href="global.html#processOnClickEvents">processOnClickEvents</a></li><li><a href="global.html#processOnclick">processOnclick</a></li><li><a href="global.html#resetFailedVisitsForDomain">resetFailedVisitsForDomain</a></li><li><a href="global.html#resetVisitedStatus">resetVisitedStatus</a></li><li><a href="global.html#resetVisitedStatusForDomain">resetVisitedStatusForDomain</a></li><li><a href="global.html#runCrawler">runCrawler</a></li><li><a href="global.html#saveJobToMySql">saveJobToMySql</a></li><li><a href="global.html#saveSeedsToMongoDB">saveSeedsToMongoDB</a></li><li><a href="global.html#scrollToBottom">scrollToBottom</a></li><li><a href="global.html#updateVisitResultDomains">updateVisitResultDomains</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">scripts/resetFailedVisits.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>require('module-alias/register');
const { VisitResult } = require('@models/visitResult');
const { mongoService } = require('@database/mongodb-service');
const { defaultLogger: logger } = require('@utils/logger');

/**
 * 특정 도메인에서 방문 실패한(success=false) URL의 방문 상태를 재설정합니다.
 * @param {string} domainName - 재설정할 도메인 이름 (예: 'example.com')
 * @returns {Promise&lt;{success: boolean, count: number, message: string}>} 작업 결과
 */
async function resetFailedVisitsForDomain(domainName) {
  try {
    // MongoDB 연결
    await mongoService.connect();

    // 도메인 문서 찾기
    const domainDoc = await VisitResult.findOne({ domain: domainName });

    if (!domainDoc) {
      return {
        success: false,
        count: 0,
        message: `도메인 '${domainName}'을 찾을 수 없습니다.`
      };
    }

    let resetCount = 0;

    // 방문에 실패한 URL들을 찾아 방문 상태 초기화
    if (domainDoc.suburl_list &amp;&amp; domainDoc.suburl_list.length > 0) {
      // 각 URL 항목을 순회하며 success=false인 항목의 visited를 false로 변경
      domainDoc.suburl_list.forEach(urlItem => {
        if (urlItem.visited === true &amp;&amp; urlItem.success === false) {
          urlItem.visited = false;
          urlItem.visitedAt = null;
          // 에러 정보 초기화 (선택 사항)
          urlItem.errors = [];
          resetCount++;
        }
      });

      // 변경사항 저장
      domainDoc.updated_at = new Date();
      await domainDoc.save();

      logger.info(`도메인 '${domainName}'의 방문 실패한 ${resetCount}개 URL 방문 상태가 재설정되었습니다.`);

      return {
        success: true,
        count: resetCount,
        message: `도메인 '${domainName}'의 방문 실패한 ${resetCount}개 URL 방문 상태가 재설정되었습니다.`
      };
    } else {
      return {
        success: true,
        count: 0,
        message: `도메인 '${domainName}'에 재설정할 URL이 없습니다.`
      };
    }

  } catch (error) {
    logger.error(`도메인 '${domainName}'의 실패 URL 방문 상태 재설정 중 오류 발생:`, error);
    return {
      success: false,
      count: 0,
      message: `오류 발생: ${error.message}`
    };
  } finally {
    // 연결 종료는 선택적으로 수행 (다른 작업이 있을 수 있음)
    // await mongoService.disconnect();
  }
}

/**
 * 특정 도메인에서 방문 실패한 URL의 상세 통계를 출력합니다.
 * @param {string} domainName - 분석할 도메인 이름
 * @returns {Promise&lt;{success: boolean, stats: Object, message: string}>} 통계 정보
 */
async function getFailedVisitStats(domainName) {
  try {
    // MongoDB 연결
    await mongoService.connect();

    // 도메인 문서 찾기
    const domainDoc = await VisitResult.findOne({ domain: domainName });

    if (!domainDoc || !domainDoc.suburl_list) {
      return {
        success: false,
        stats: {},
        message: `도메인 '${domainName}'을 찾을 수 없거나 URL 목록이 없습니다.`
      };
    }

    // 통계 정보 초기화
    const stats = {
      totalUrls: domainDoc.suburl_list.length,
      visitedUrls: 0,
      successfulVisits: 0,
      failedVisits: 0,
      errorTypes: {}
    };

    // 통계 데이터 수집
    domainDoc.suburl_list.forEach(urlItem => {
      if (urlItem.visited) {
        stats.visitedUrls++;

        if (urlItem.success) {
          stats.successfulVisits++;
        } else {
          stats.failedVisits++;

          // 에러 유형별 카운트 (있는 경우)
          if (urlItem.errors &amp;&amp; urlItem.errors.length > 0) {
            urlItem.errors.forEach(error => {
              const errorType = error.type || 'unknown';
              stats.errorTypes[errorType] = (stats.errorTypes[errorType] || 0) + 1;
            });
          }
        }
      }
    });

    return {
      success: true,
      stats,
      message: `도메인 '${domainName}'의 방문 통계 분석 완료`
    };
  } catch (error) {
    logger.error(`도메인 '${domainName}'의 방문 통계 분석 중 오류 발생:`, error);
    return {
      success: false,
      stats: {},
      message: `오류 발생: ${error.message}`
    };
  }
}

// 스크립트를 직접 실행할 경우 사용하는 코드
if (require.main === module) {
  // 명령줄 인수에서 도메인 이름과 옵션 가져오기
  const domainName = process.argv[2];
  const showStats = process.argv.includes('--stats');

  if (!domainName) {
    console.log('사용법: node resetFailedVisits.js &lt;도메인명> [--stats]');
    console.log('  --stats: 재설정 전에 실패한 URL 통계 표시');
    process.exit(1);
  }

  // 통계 요청이 있으면 먼저 통계 표시
  const runScript = async () => {
    if (showStats) {
      const statsResult = await getFailedVisitStats(domainName);
      if (statsResult.success) {
        console.log('\n===== 방문 통계 =====');
        console.log(`총 URL 수: ${statsResult.stats.totalUrls}`);
        console.log(`방문한 URL 수: ${statsResult.stats.visitedUrls}`);
        console.log(`성공한 방문 수: ${statsResult.stats.successfulVisits}`);
        console.log(`실패한 방문 수: ${statsResult.stats.failedVisits}`);

        if (Object.keys(statsResult.stats.errorTypes).length > 0) {
          console.log('\n----- 에러 유형별 통계 -----');
          Object.entries(statsResult.stats.errorTypes).forEach(([type, count]) => {
            console.log(`  ${type}: ${count}개`);
          });
        }
        console.log('======================\n');
      } else {
        console.warn(statsResult.message);
      }
    }

    // 실패한 URL 재설정 실행
    const result = await resetFailedVisitsForDomain(domainName);
    console.log(result.message);

    // MongoDB 연결 종료
    await mongoService.disconnect();
    process.exit(result.success ? 0 : 1);
  };

  runScript().catch(err => {
    console.error('실행 중 오류 발생:', err);
    process.exit(1);
  });
}

module.exports = {
  resetFailedVisitsForDomain,
  getFailedVisitStats
};</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.4</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
