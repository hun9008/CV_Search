<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>crawl/worker-task.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BaseWorkerManager.html">BaseWorkerManager</a><ul class='methods'><li data-type='method'><a href="BaseWorkerManager.html#closeBrowser">closeBrowser</a></li><li data-type='method'><a href="BaseWorkerManager.html#connect">connect</a></li><li data-type='method'><a href="BaseWorkerManager.html#disconnect">disconnect</a></li><li data-type='method'><a href="BaseWorkerManager.html#extractLinks">extractLinks</a></li><li data-type='method'><a href="BaseWorkerManager.html#extractPageContent">extractPageContent</a></li><li data-type='method'><a href="BaseWorkerManager.html#filterAllowedUrls">filterAllowedUrls</a></li><li data-type='method'><a href="BaseWorkerManager.html#getNextUrl">getNextUrl</a></li><li data-type='method'><a href="BaseWorkerManager.html#getUrlForDomain">getUrlForDomain</a></li><li data-type='method'><a href="BaseWorkerManager.html#groupUrlsByDomain">groupUrlsByDomain</a></li><li data-type='method'><a href="BaseWorkerManager.html#handleDomainError">handleDomainError</a></li><li data-type='method'><a href="BaseWorkerManager.html#initAvailableDomains">initAvailableDomains</a></li><li data-type='method'><a href="BaseWorkerManager.html#initBrowser">initBrowser</a></li><li data-type='method'><a href="BaseWorkerManager.html#processQueue">processQueue</a></li><li data-type='method'><a href="BaseWorkerManager.html#run">run</a></li><li data-type='method'><a href="BaseWorkerManager.html#saveErrorScreenshot">saveErrorScreenshot</a></li><li data-type='method'><a href="BaseWorkerManager.html#saveVisitResult">saveVisitResult</a></li><li data-type='method'><a href="BaseWorkerManager.html#selectTargetDomain">selectTargetDomain</a></li><li data-type='method'><a href="BaseWorkerManager.html#tryNextDomain">tryNextDomain</a></li><li data-type='method'><a href="BaseWorkerManager.html#visitUrl">visitUrl</a></li></ul></li><li><a href="ClaudeParser.html">ClaudeParser</a><ul class='methods'><li data-type='method'><a href="ClaudeParser.html#connect">connect</a></li><li data-type='method'><a href="ClaudeParser.html#convertToRecruitInfoSchema">convertToRecruitInfoSchema</a></li><li data-type='method'><a href="ClaudeParser.html#fetchRecruitUrls">fetchRecruitUrls</a></li><li data-type='method'><a href="ClaudeParser.html#processUrl">processUrl</a></li><li data-type='method'><a href="ClaudeParser.html#requestUrlParse">requestUrlParse</a></li><li data-type='method'><a href="ClaudeParser.html#run">run</a></li><li data-type='method'><a href="ClaudeParser.html#saveRecruitInfo">saveRecruitInfo</a></li><li data-type='method'><a href="ClaudeParser.html#wait">wait</a></li></ul></li><li><a href="ClaudeService.html">ClaudeService</a><ul class='methods'><li data-type='method'><a href="ClaudeService.html#generateContent">generateContent</a></li><li data-type='method'><a href="ClaudeService.html#getRecruitmentPrompt">getRecruitmentPrompt</a></li><li data-type='method'><a href="ClaudeService.html#getStatus">getStatus</a></li><li data-type='method'><a href="ClaudeService.html#initializeClient">initializeClient</a></li></ul></li><li><a href="GeminiService.html">GeminiService</a><ul class='methods'><li data-type='method'><a href="GeminiService.html#generateContent">generateContent</a></li><li data-type='method'><a href="GeminiService.html#getKeyStatus">getKeyStatus</a></li><li data-type='method'><a href="GeminiService.html#getRecruitmentPrompt">getRecruitmentPrompt</a></li><li data-type='method'><a href="GeminiService.html#getRecruitmentSchema">getRecruitmentSchema</a></li><li data-type='method'><a href="GeminiService.html#initializeClient">initializeClient</a></li><li data-type='method'><a href="GeminiService.html#parseRecruitment">parseRecruitment</a></li><li data-type='method'><a href="GeminiService.html#rotateApiKey">rotateApiKey</a></li></ul></li><li><a href="Logger.html">Logger</a><ul class='methods'><li data-type='method'><a href="Logger.html#checkLogFileDate">checkLogFileDate</a></li><li data-type='method'><a href="Logger.html#colorize">colorize</a></li><li data-type='method'><a href="Logger.html#formatJsonMessage">formatJsonMessage</a></li><li data-type='method'><a href="Logger.html#formatJsonMessage">formatJsonMessage</a></li><li data-type='method'><a href="Logger.html#formatTextMessage">formatTextMessage</a></li><li data-type='method'><a href="Logger.html#log">log</a></li><li data-type='method'><a href="Logger.html#logEvent">logEvent</a></li><li data-type='method'><a href="Logger.html#setupLogFiles">setupLogFiles</a></li><li data-type='method'><a href="Logger.html#setupLogRotation">setupLogRotation</a></li></ul></li><li><a href="MongoDBService.html">MongoDBService</a><ul class='methods'><li data-type='method'><a href="MongoDBService.html#connect">connect</a></li><li data-type='method'><a href="MongoDBService.html#disconnect">disconnect</a></li><li data-type='method'><a href="MongoDBService.html#getConnection">getConnection</a></li><li data-type='method'><a href="MongoDBService.html#getConnectionStatus">getConnectionStatus</a></li><li data-type='method'><a href="MongoDBService.html#getMongoose">getMongoose</a></li><li data-type='method'><a href="MongoDBService.html#setDbName">setDbName</a></li><li data-type='method'><a href="MongoDBService.html#setUri">setUri</a></li></ul></li><li><a href="OnClickWorker.html">OnClickWorker</a><ul class='methods'><li data-type='method'><a href="OnClickWorker.html#checkUrlChanges">checkUrlChanges</a></li><li data-type='method'><a href="OnClickWorker.html#cleanup">cleanup</a></li><li data-type='method'><a href="OnClickWorker.html#execute">execute</a></li><li data-type='method'><a href="OnClickWorker.html#formatResult">formatResult</a></li><li data-type='method'><a href="OnClickWorker.html#initialize">initialize</a></li><li data-type='method'><a href="OnClickWorker.html#scrollFullPage">scrollFullPage</a></li><li data-type='method'><a href="OnClickWorker.html#scrollPage">scrollPage</a></li><li data-type='method'><a href="OnClickWorker.html#setupPage">setupPage</a></li></ul></li><li><a href="ParseManager.html">ParseManager</a><ul class='methods'><li data-type='method'><a href="ParseManager.html#cancel">cancel</a></li><li data-type='method'><a href="ParseManager.html#connect">connect</a></li><li data-type='method'><a href="ParseManager.html#convertToRecruitInfoSchema">convertToRecruitInfoSchema</a></li><li data-type='method'><a href="ParseManager.html#fetchUnclassifiedUrls">fetchUnclassifiedUrls</a></li><li data-type='method'><a href="ParseManager.html#getStatus">getStatus</a></li><li data-type='method'><a href="ParseManager.html#processUrl">processUrl</a></li><li data-type='method'><a href="ParseManager.html#requestUrlParse">requestUrlParse</a></li><li data-type='method'><a href="ParseManager.html#run">run</a></li><li data-type='method'><a href="ParseManager.html#saveRecruitInfo">saveRecruitInfo</a></li><li data-type='method'><a href="ParseManager.html#wait">wait</a></li></ul></li><li><a href="RecruitInfoDbService.html">RecruitInfoDbService</a><ul class='methods'><li data-type='method'><a href="RecruitInfoDbService.html#bulkCreateOrUpdate">bulkCreateOrUpdate</a></li><li data-type='method'><a href="RecruitInfoDbService.html#bulkDelete">bulkDelete</a></li><li data-type='method'><a href="RecruitInfoDbService.html#createOrUpdate">createOrUpdate</a></li><li data-type='method'><a href="RecruitInfoDbService.html#deleteByUrl">deleteByUrl</a></li><li data-type='method'><a href="RecruitInfoDbService.html#deleteExpired">deleteExpired</a></li><li data-type='method'><a href="RecruitInfoDbService.html#getAll">getAll</a></li><li data-type='method'><a href="RecruitInfoDbService.html#getByUrl">getByUrl</a></li><li data-type='method'><a href="RecruitInfoDbService.html#getStats">getStats</a></li><li data-type='method'><a href="RecruitInfoDbService.html#search">search</a></li><li data-type='method'><a href="RecruitInfoDbService.html#searchByKeywords">searchByKeywords</a></li></ul></li><li><a href="WorkerPool.html">WorkerPool</a><ul class='methods'><li data-type='method'><a href="WorkerPool.html#enqueue">enqueue</a></li><li data-type='method'><a href="WorkerPool.html#processQueue">processQueue</a></li><li data-type='method'><a href="WorkerPool.html#processTasks">processTasks</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#RecruitInfo">RecruitInfo</a></li><li><a href="global.html#createTableIfNotExists">createTableIfNotExists</a></li><li><a href="global.html#extractAndExecuteScripts">extractAndExecuteScripts</a></li><li><a href="global.html#extractAndProcessOnClicks">extractAndProcessOnClicks</a></li><li><a href="global.html#extractDomain">extractDomain</a></li><li><a href="global.html#getClaudeJobById">getClaudeJobById</a></li><li><a href="global.html#getClaudeJobFilters">getClaudeJobFilters</a></li><li><a href="global.html#getClaudeJobStats">getClaudeJobStats</a></li><li><a href="global.html#getClaudeJobs">getClaudeJobs</a></li><li><a href="global.html#getCompleteClaudeJobs">getCompleteClaudeJobs</a></li><li><a href="global.html#getCompletionStats">getCompletionStats</a></li><li><a href="global.html#getDomainStats">getDomainStats</a></li><li><a href="global.html#getExperienceStats">getExperienceStats</a></li><li><a href="global.html#getFailedVisitStats">getFailedVisitStats</a></li><li><a href="global.html#getJobById">getJobById</a></li><li><a href="global.html#getJobTypeStats">getJobTypeStats</a></li><li><a href="global.html#getJobs">getJobs</a></li><li><a href="global.html#getMySqlJobFilters">getMySqlJobFilters</a></li><li><a href="global.html#getMySqlJobs">getMySqlJobs</a></li><li><a href="global.html#getResults">getResults</a></li><li><a href="global.html#getStats">getStats</a></li><li><a href="global.html#getUrlDetails">getUrlDetails</a></li><li><a href="global.html#getUrlSeed">getUrlSeed</a></li><li><a href="global.html#getUrlStats">getUrlStats</a></li><li><a href="global.html#handler">handler</a></li><li><a href="global.html#infiniteScroll">infiniteScroll</a></li><li><a href="global.html#isUrlAllowed">isUrlAllowed</a></li><li><a href="global.html#isUrlAllowedWithRobots">isUrlAllowedWithRobots</a></li><li><a href="global.html#logProgress">logProgress</a></li><li><a href="global.html#main">main</a></li><li><a href="global.html#parseRobotsTxt">parseRobotsTxt</a></li><li><a href="global.html#processOnClickEvents">processOnClickEvents</a></li><li><a href="global.html#processOnclick">processOnclick</a></li><li><a href="global.html#resetFailedVisitsForDomain">resetFailedVisitsForDomain</a></li><li><a href="global.html#resetVisitedStatus">resetVisitedStatus</a></li><li><a href="global.html#resetVisitedStatusForDomain">resetVisitedStatusForDomain</a></li><li><a href="global.html#runCrawler">runCrawler</a></li><li><a href="global.html#saveJobToMySql">saveJobToMySql</a></li><li><a href="global.html#saveSeedsToMongoDB">saveSeedsToMongoDB</a></li><li><a href="global.html#scrollToBottom">scrollToBottom</a></li><li><a href="global.html#updateVisitResultDomains">updateVisitResultDomains</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">crawl/worker-task.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const puppeteer = require('puppeteer');
const { defaultLogger: logger } = require('@utils/logger');

/**
 * Onclick 스크립트를 실행하는 작업자 클래스
 */
class OnClickWorker {
  /**
   * @param {Object} options 작업 옵션
   * @param {number} options.id 작업 ID
   * @param {string} options.currentUrl 기본 URL
   * @param {Object} options.onclickItem onclick 요소 정보
   * @param {number} options.index 작업 인덱스
   * @param {number} options.total 전체 작업 수
   * @param {boolean} options.headless 헤드리스 모드 여부
   * @param {number} options.timeout 시간 제한(ms)
    */
  constructor(options) {
    this.id = options.id || Date.now();
    this.currentUrl = options.currentUrl;
    this.onclickItem = options.onclickItem;
    this.index = options.index;
    this.total = options.total;
    this.headless = options.headless !== false;
    this.timeout = options.timeout || 3000;
    this.urlDetectionTimeout = options.urlDetectionTimeout || 3000;

    // 브라우저 인스턴스가 제공되면 재사용
    this.sharedBrowser = options.browser || null;
    this.browser = null;
    this.page = null;
    this.useSharedBrowser = !!this.sharedBrowser;
  }

/**
 * 페이지를 스크롤합니다.
 * @param {Object} options 스크롤 옵션
 * @param {number} options.distance 스크롤 거리 (픽셀)
 * @param {number} options.delay 스크롤 사이의 지연 시간 (ms)
 * @param {number} options.steps 스크롤 단계 수
 * @returns {Promise&lt;void>}
 */
async scrollPage(options = {}) {
  const {
    distance = 500,       // 기본 스크롤 거리
    delay = 100,          // 기본 지연 시간
    steps = 5,            // 기본 스크롤 단계 수
    fullPage = false      // 전체 페이지 스크롤 여부
  } = options;

  logger.debug(`[Worker ${this.id}] 페이지 스크롤 시작...`);

  try {
    if (fullPage) {
      // 전체 페이지 스크롤 (페이지 끝까지)
      await this.scrollFullPage(delay);
    } else {
      // 지정된 거리만큼 단계별 스크롤
      for (let i = 0; i &lt; steps; i++) {
        await this.page.evaluate((scrollDistance) => {
          window.scrollBy(0, scrollDistance);
        }, distance);

        logger.debug(`[Worker ${this.id}] 스크롤 ${i + 1}/${steps} 완료 (${distance}px)`);
        await new Promise(resolve => setTimeout(resolve, delay));
      }
    }

    logger.debug(`[Worker ${this.id}] 페이지 스크롤 완료`);
  } catch (error) {
    logger.error(`[Worker ${this.id}] 페이지 스크롤 중 오류:`, error);
  }
}

/**
 * 페이지 끝까지 자동 스크롤합니다.
 * @param {number} delay 스크롤 사이의 지연 시간 (ms)
 * @returns {Promise&lt;void>}
 */
async scrollFullPage(delay = 100) {
  logger.debug(`[Worker ${this.id}] 전체 페이지 스크롤 시작...`);

  try {
    await this.page.evaluate(async (scrollDelay) => {
      await new Promise((resolve) => {
        let totalHeight = 0;
        const distance = 300;

        const timer = setInterval(() => {
          const scrollHeight = document.body.scrollHeight;
          window.scrollBy(0, distance);
          totalHeight += distance;

          // 페이지 끝에 도달하거나 더 이상 스크롤되지 않으면 중지
          if (totalHeight >= scrollHeight) {
            clearInterval(timer);
            resolve();
          }
        }, scrollDelay);
      });
    }, delay);

    logger.debug(`[Worker ${this.id}] 전체 페이지 스크롤 완료`);
  } catch (error) {
    logger.error(`[Worker ${this.id}] 전체 페이지 스크롤 중 오류:`, error);
  }
}

  /**
   * onclick 스크립트를 실행합니다.
   * @returns {Promise&lt;Object>} 실행 결과
   */
  async execute() {
    // 작업 시작 로그
    logger.debug(`[Worker ${this.id}] onclick 스크립트 ${this.index}/${this.total} 실행 시작...`);

    try {
      // 브라우저 및 페이지 초기화
      await this.initialize();

      // 페이지 설정
      await this.setupPage();

      await this.scrollPage();

      // 실행 전 URL 기록
      const beforeUrl = await this.page.url();

      // onclick 실행
      const result = await this.executeOnclick();

      // URL 변경 감지
      await this.checkUrlChanges(result, beforeUrl);

      // 결과 형식 설정
      this.formatResult(result);

      // 자원 정리
      await this.cleanup();

      logger.debug(`[Worker ${this.id}] onclick ${this.index} 실행 완료: ${result.success ? (result.urlChanged ? '페이지 이동 감지' : '정상 실행') : '실패'}`);

      return result;
    } catch (error) {
      logger.error(`[Worker ${this.id}] onclick 실행 중 오류:`, error);

      // 브라우저가 열려있으면 닫기
      await this.cleanup();

      return {
        sourceType: 'onclick',
        index: this.index,
        success: false,
        error: error.toString(),
        elementInfo: {
          tagName: this.onclickItem.tagName,
          id: this.onclickItem.id,
          className: this.onclickItem.className,
          text: this.onclickItem.text
        },
        message: '실행 중 예외 발생'
      };
    }
  }

  /**
   * 브라우저와 페이지를 초기화합니다.
   */
// initialize 메서드도 수정
  async initialize() {
    if (this.useSharedBrowser) {
      // 공유 브라우저 인스턴스 사용
      this.browser = this.sharedBrowser;
    } else {
      // 새 브라우저 인스턴스 생성
      this.browser = await puppeteer.launch({
        headless: this.headless
      });
    }

    // 페이지 생성
    this.page = await this.browser.newPage();
  }
  /**
   * 페이지를 설정합니다.
   */
  async setupPage() {
    // 자바스크립트 대화상자 처리
    this.page.on('dialog', async dialog => {
      logger.debug(`[Worker ${this.id}] onclick ${this.index} 대화상자 감지: ${dialog.type()}, 메시지: ${dialog.message()}`);
      await dialog.dismiss();
    });

    // 각 탭에 번호를 표시하기 위해 제목 변경
    await this.page.evaluate((index, id) => {
      document.title = `onclick 실행 ${index} (Worker ${id})`;
    }, this.index, this.id);

    // 콘솔 로그를 가로채서 출력
    this.page.on('console', msg => logger.debug(`[Worker ${this.id}] onclick ${this.index} 콘솔:`, msg.text()));

    // 페이지 로드
    await this.page.goto(this.currentUrl, {
      waitUntil: 'networkidle2',
      timeout: 6000 // 충분한 로드 시간 제공
    });
  }

  async executeOnclick() {
  return this.page.evaluate(async (onclickCode, elementInfo, timeout) => {
    return new Promise(resolve => {
      // 타임아웃 설정
      const timeoutId = setTimeout(() => {
        resolve({
          success: true,
          message: '실행 완료 (타임아웃)'
        });
      }, timeout);

      try {
        // 대화상자 함수 오버라이드
        window.alert = function(message) {
          console.log(`Alert 대화상자: ${message}`);
          return undefined;
        };

        window.confirm = function(message) {
          console.log(`Confirm 대화상자: ${message}`);
          return true; // 항상 확인 버튼 클릭으로 처리
        };

        window.prompt = function(message, defaultValue) {
          console.log(`Prompt 대화상자: ${message}`);
          return defaultValue || ''; // 기본값이나 빈 문자열 반환
        };

        // 실행될 onclick 코드에 대한 정보 출력
        console.log(`${elementInfo.tagName} 요소의 onclick 실행: ${onclickCode}`);

        // URL 변경 감지를 위한 기존 함수 백업
        const originalAssign = window.location.assign;
        const originalReplace = window.location.replace;
        const originalOpen = window.open;
        let detectedUrl = null;
        let urlChanged = false;

        // location 함수 오버라이드 (주석 해제)
        window.location.assign = function(url) {
          detectedUrl = url;
          urlChanged = true;
          clearTimeout(timeoutId);
          resolve({
            success: true,
            detectedUrl: url,
            urlChanged: true,
            message: 'location.assign 호출됨'
          });
          return originalAssign.call(window.location, url);
        };

        window.location.replace = function(url) {
          detectedUrl = url;
          urlChanged = true;
          clearTimeout(timeoutId);
          resolve({
            success: true,
            detectedUrl: url,
            urlChanged: true,
            message: 'location.replace 호출됨'
          });
          return originalReplace.call(window.location, url);
        };

        // location.href 속성 재정의
        try {
          Object.defineProperty(window.location, 'href', {
            set: function(url) {
              detectedUrl = url;
              urlChanged = true;
              clearTimeout(timeoutId);
              resolve({
                success: true,
                detectedUrl: url,
                urlChanged: true,
                message: 'location.href 설정됨'
              });
              return url;
            },
            get: function() {
              return window.location.toString();
            }
          });
        } catch (e) {
          console.error('location.href 속성 재정의 실패:', e);
        }

        // window.open 오버라이드
        window.open = function(url) {
          detectedUrl = url;
          urlChanged = true;
          clearTimeout(timeoutId);
          resolve({
            success: true,
            detectedUrl: url,
            urlChanged: true,
            message: 'window.open 호출됨'
          });
          return originalOpen ? originalOpen.call(window, url) : null;
        };

        console.warn(`onclick 코드 실행: ${onclickCode}`);
        // onclick 코드 실행
        eval(onclickCode);

        // URL이 변경되지 않았다면 바로 결과 반환
        if (!urlChanged) {
          clearTimeout(timeoutId);
          resolve({
            success: true,
            detectedUrl: null,
            urlChanged: false,
            message: '실행 완료 (URL 변경 없음)'
          });
        }
      } catch (error) {
        clearTimeout(timeoutId);
        console.error('onclick 실행 오류:', error.toString());
        resolve({
          success: false,
          error: error.toString(),
          message: 'onclick 실행 중 오류 발생'
        });
      }
    });
  }, this.onclickItem.onclick, {
    tagName: this.onclickItem.tagName,
    id: this.onclickItem.id,
    className: this.onclickItem.className,
    text: this.onclickItem.text
  }, this.timeout);
}
  /**
   * URL 변경을 확인하고 결과에 반영합니다.
   * @param {Object} result 결과 객체
   * @param {string} beforeUrl 실행 전 URL
   */
  async checkUrlChanges(result, beforeUrl) {
    // URL 변경 감지를 위해 추가 대기
    await new Promise(resolve => setTimeout(resolve, this.urlDetectionTimeout));

    // 실행 후 URL 확인
    const afterUrl = await this.page.url();
    logger.debug(`[Worker ${this.id}] afterUrl: ${afterUrl}`);

    // URL 변경 확인
    if (afterUrl !== beforeUrl) {
      result.urlChanged = true;
      result.detectedUrl = afterUrl;
      result.message = 'URL 변경 감지됨 (페이지 이동 확인)';

      // 이 단계에서는 URL을 수집하지 않고 결과만 반환
      // URL 수집은 메인 스레드에서 처리
    } else if (!result.urlChanged) {
      result.urlChanged = false;
      result.detectedUrl = null;
    }
  }

  /**
   * 결과 객체에 추가 정보를 설정합니다.
   * @param {Object} result 결과 객체
   */
  formatResult(result) {
    result.originalScript = this.onclickItem.onclick;
    result.sourceType = 'onclick';
    result.index = this.index;
    result.elementInfo = {
      tagName: this.onclickItem.tagName,
      id: this.onclickItem.id,
      className: this.onclickItem.className,
      text: this.onclickItem.text
    };
  }

  /**
   * 브라우저와 페이지 리소스를 정리합니다.
   */
 // cleanup 메서드도 수정
  async cleanup() {
    if (this.page) {
      try {
        await this.page.close();
        this.page = null;
      } catch (error) {
        logger.error(`[Worker ${this.id}] 페이지 종료 중 오류:`, error);
      }
    }

    // 공유 브라우저가 아닌 경우에만 브라우저를 닫음
    if (this.browser &amp;&amp; !this.useSharedBrowser) {
      try {
        await this.browser.close();
      } catch (error) {
        logger.error(`[Worker ${this.id}] 브라우저 종료 중 오류:`, error);
      }
      this.browser = null;
    }
  }
}

/**
 * 작업 풀을 관리하는 클래스
 */
class WorkerPool {
  /**
   * @param {number} maxConcurrency 최대 동시 실행 작업 수
   */
  constructor(maxConcurrency = 5) {
    this.maxConcurrency = maxConcurrency;
    this.active = 0;
    this.queue = [];
  }

  /**
   * 작업을 실행 큐에 추가합니다.
   * @param {Object} options 작업 옵션
   * @returns {Promise&lt;Object>} 작업 결과
   */
  async enqueue(options) {
    return new Promise((resolve) => {
      const task = {
        options,
        execute: async () => {
          this.active++;
          try {
            const worker = new OnClickWorker(options);
            const result = await worker.execute();
            resolve(result);
          } catch (error) {
            logger.error(`[WorkerPool] 작업 실행 오류:`, error);
            resolve({
              success: false,
              error: error.toString(),
              sourceType: 'onclick',
              index: options.index,
              message: '작업 풀에서 실행 중 오류 발생'
            });
          } finally {
            this.active--;
            this.processQueue();
          }
        }
      };

      this.queue.push(task);
      this.processQueue();
    });
  }

  /**
   * 큐에 있는 작업을 처리합니다.
   */
  processQueue() {
    while (this.active &lt; this.maxConcurrency &amp;&amp; this.queue.length > 0) {
      const task = this.queue.shift();
      task.execute();
    }
  }

  /**
   * 여러 작업을 병렬로 처리합니다.
   * @param {Array&lt;Object>} tasks 작업 옵션 배열
   * @returns {Promise&lt;Array&lt;Object>>} 작업 결과 배열
   */
  async processTasks(tasks) {
    const promises = tasks.map(task => this.enqueue(task));
    return Promise.all(promises);
  }
}

module.exports = { OnClickWorker, WorkerPool };</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.4</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
