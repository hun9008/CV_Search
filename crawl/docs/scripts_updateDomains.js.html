<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>scripts/updateDomains.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BaseWorkerManager.html">BaseWorkerManager</a><ul class='methods'><li data-type='method'><a href="BaseWorkerManager.html#closeBrowser">closeBrowser</a></li><li data-type='method'><a href="BaseWorkerManager.html#connect">connect</a></li><li data-type='method'><a href="BaseWorkerManager.html#disconnect">disconnect</a></li><li data-type='method'><a href="BaseWorkerManager.html#extractLinks">extractLinks</a></li><li data-type='method'><a href="BaseWorkerManager.html#extractPageContent">extractPageContent</a></li><li data-type='method'><a href="BaseWorkerManager.html#filterAllowedUrls">filterAllowedUrls</a></li><li data-type='method'><a href="BaseWorkerManager.html#getNextUrl">getNextUrl</a></li><li data-type='method'><a href="BaseWorkerManager.html#getUrlForDomain">getUrlForDomain</a></li><li data-type='method'><a href="BaseWorkerManager.html#groupUrlsByDomain">groupUrlsByDomain</a></li><li data-type='method'><a href="BaseWorkerManager.html#handleDomainError">handleDomainError</a></li><li data-type='method'><a href="BaseWorkerManager.html#initAvailableDomains">initAvailableDomains</a></li><li data-type='method'><a href="BaseWorkerManager.html#initBrowser">initBrowser</a></li><li data-type='method'><a href="BaseWorkerManager.html#processQueue">processQueue</a></li><li data-type='method'><a href="BaseWorkerManager.html#run">run</a></li><li data-type='method'><a href="BaseWorkerManager.html#saveErrorScreenshot">saveErrorScreenshot</a></li><li data-type='method'><a href="BaseWorkerManager.html#saveVisitResult">saveVisitResult</a></li><li data-type='method'><a href="BaseWorkerManager.html#selectTargetDomain">selectTargetDomain</a></li><li data-type='method'><a href="BaseWorkerManager.html#tryNextDomain">tryNextDomain</a></li><li data-type='method'><a href="BaseWorkerManager.html#visitUrl">visitUrl</a></li></ul></li><li><a href="ClaudeParser.html">ClaudeParser</a><ul class='methods'><li data-type='method'><a href="ClaudeParser.html#connect">connect</a></li><li data-type='method'><a href="ClaudeParser.html#convertToRecruitInfoSchema">convertToRecruitInfoSchema</a></li><li data-type='method'><a href="ClaudeParser.html#fetchRecruitUrls">fetchRecruitUrls</a></li><li data-type='method'><a href="ClaudeParser.html#processUrl">processUrl</a></li><li data-type='method'><a href="ClaudeParser.html#requestUrlParse">requestUrlParse</a></li><li data-type='method'><a href="ClaudeParser.html#run">run</a></li><li data-type='method'><a href="ClaudeParser.html#saveRecruitInfo">saveRecruitInfo</a></li><li data-type='method'><a href="ClaudeParser.html#wait">wait</a></li></ul></li><li><a href="ClaudeService.html">ClaudeService</a><ul class='methods'><li data-type='method'><a href="ClaudeService.html#generateContent">generateContent</a></li><li data-type='method'><a href="ClaudeService.html#getRecruitmentPrompt">getRecruitmentPrompt</a></li><li data-type='method'><a href="ClaudeService.html#getStatus">getStatus</a></li><li data-type='method'><a href="ClaudeService.html#initializeClient">initializeClient</a></li></ul></li><li><a href="GeminiService.html">GeminiService</a><ul class='methods'><li data-type='method'><a href="GeminiService.html#generateContent">generateContent</a></li><li data-type='method'><a href="GeminiService.html#getKeyStatus">getKeyStatus</a></li><li data-type='method'><a href="GeminiService.html#getRecruitmentPrompt">getRecruitmentPrompt</a></li><li data-type='method'><a href="GeminiService.html#getRecruitmentSchema">getRecruitmentSchema</a></li><li data-type='method'><a href="GeminiService.html#initializeClient">initializeClient</a></li><li data-type='method'><a href="GeminiService.html#parseRecruitment">parseRecruitment</a></li><li data-type='method'><a href="GeminiService.html#rotateApiKey">rotateApiKey</a></li></ul></li><li><a href="Logger.html">Logger</a><ul class='methods'><li data-type='method'><a href="Logger.html#checkLogFileDate">checkLogFileDate</a></li><li data-type='method'><a href="Logger.html#colorize">colorize</a></li><li data-type='method'><a href="Logger.html#formatJsonMessage">formatJsonMessage</a></li><li data-type='method'><a href="Logger.html#formatJsonMessage">formatJsonMessage</a></li><li data-type='method'><a href="Logger.html#formatTextMessage">formatTextMessage</a></li><li data-type='method'><a href="Logger.html#log">log</a></li><li data-type='method'><a href="Logger.html#logEvent">logEvent</a></li><li data-type='method'><a href="Logger.html#setupLogFiles">setupLogFiles</a></li><li data-type='method'><a href="Logger.html#setupLogRotation">setupLogRotation</a></li></ul></li><li><a href="MongoDBService.html">MongoDBService</a><ul class='methods'><li data-type='method'><a href="MongoDBService.html#connect">connect</a></li><li data-type='method'><a href="MongoDBService.html#disconnect">disconnect</a></li><li data-type='method'><a href="MongoDBService.html#getConnection">getConnection</a></li><li data-type='method'><a href="MongoDBService.html#getConnectionStatus">getConnectionStatus</a></li><li data-type='method'><a href="MongoDBService.html#getMongoose">getMongoose</a></li><li data-type='method'><a href="MongoDBService.html#setDbName">setDbName</a></li><li data-type='method'><a href="MongoDBService.html#setUri">setUri</a></li></ul></li><li><a href="OnClickWorker.html">OnClickWorker</a><ul class='methods'><li data-type='method'><a href="OnClickWorker.html#checkUrlChanges">checkUrlChanges</a></li><li data-type='method'><a href="OnClickWorker.html#cleanup">cleanup</a></li><li data-type='method'><a href="OnClickWorker.html#execute">execute</a></li><li data-type='method'><a href="OnClickWorker.html#formatResult">formatResult</a></li><li data-type='method'><a href="OnClickWorker.html#initialize">initialize</a></li><li data-type='method'><a href="OnClickWorker.html#scrollFullPage">scrollFullPage</a></li><li data-type='method'><a href="OnClickWorker.html#scrollPage">scrollPage</a></li><li data-type='method'><a href="OnClickWorker.html#setupPage">setupPage</a></li></ul></li><li><a href="ParseManager.html">ParseManager</a><ul class='methods'><li data-type='method'><a href="ParseManager.html#cancel">cancel</a></li><li data-type='method'><a href="ParseManager.html#connect">connect</a></li><li data-type='method'><a href="ParseManager.html#convertToRecruitInfoSchema">convertToRecruitInfoSchema</a></li><li data-type='method'><a href="ParseManager.html#fetchUnclassifiedUrls">fetchUnclassifiedUrls</a></li><li data-type='method'><a href="ParseManager.html#getStatus">getStatus</a></li><li data-type='method'><a href="ParseManager.html#processUrl">processUrl</a></li><li data-type='method'><a href="ParseManager.html#requestUrlParse">requestUrlParse</a></li><li data-type='method'><a href="ParseManager.html#run">run</a></li><li data-type='method'><a href="ParseManager.html#saveRecruitInfo">saveRecruitInfo</a></li><li data-type='method'><a href="ParseManager.html#wait">wait</a></li></ul></li><li><a href="RecruitInfoDbService.html">RecruitInfoDbService</a><ul class='methods'><li data-type='method'><a href="RecruitInfoDbService.html#bulkCreateOrUpdate">bulkCreateOrUpdate</a></li><li data-type='method'><a href="RecruitInfoDbService.html#bulkDelete">bulkDelete</a></li><li data-type='method'><a href="RecruitInfoDbService.html#createOrUpdate">createOrUpdate</a></li><li data-type='method'><a href="RecruitInfoDbService.html#deleteByUrl">deleteByUrl</a></li><li data-type='method'><a href="RecruitInfoDbService.html#deleteExpired">deleteExpired</a></li><li data-type='method'><a href="RecruitInfoDbService.html#getAll">getAll</a></li><li data-type='method'><a href="RecruitInfoDbService.html#getByUrl">getByUrl</a></li><li data-type='method'><a href="RecruitInfoDbService.html#getStats">getStats</a></li><li data-type='method'><a href="RecruitInfoDbService.html#search">search</a></li><li data-type='method'><a href="RecruitInfoDbService.html#searchByKeywords">searchByKeywords</a></li></ul></li><li><a href="WorkerPool.html">WorkerPool</a><ul class='methods'><li data-type='method'><a href="WorkerPool.html#enqueue">enqueue</a></li><li data-type='method'><a href="WorkerPool.html#processQueue">processQueue</a></li><li data-type='method'><a href="WorkerPool.html#processTasks">processTasks</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#RecruitInfo">RecruitInfo</a></li><li><a href="global.html#createTableIfNotExists">createTableIfNotExists</a></li><li><a href="global.html#extractAndExecuteScripts">extractAndExecuteScripts</a></li><li><a href="global.html#extractAndProcessOnClicks">extractAndProcessOnClicks</a></li><li><a href="global.html#extractDomain">extractDomain</a></li><li><a href="global.html#getClaudeJobById">getClaudeJobById</a></li><li><a href="global.html#getClaudeJobFilters">getClaudeJobFilters</a></li><li><a href="global.html#getClaudeJobStats">getClaudeJobStats</a></li><li><a href="global.html#getClaudeJobs">getClaudeJobs</a></li><li><a href="global.html#getCompleteClaudeJobs">getCompleteClaudeJobs</a></li><li><a href="global.html#getCompletionStats">getCompletionStats</a></li><li><a href="global.html#getDomainStats">getDomainStats</a></li><li><a href="global.html#getExperienceStats">getExperienceStats</a></li><li><a href="global.html#getFailedVisitStats">getFailedVisitStats</a></li><li><a href="global.html#getJobById">getJobById</a></li><li><a href="global.html#getJobTypeStats">getJobTypeStats</a></li><li><a href="global.html#getJobs">getJobs</a></li><li><a href="global.html#getMySqlJobFilters">getMySqlJobFilters</a></li><li><a href="global.html#getMySqlJobs">getMySqlJobs</a></li><li><a href="global.html#getResults">getResults</a></li><li><a href="global.html#getStats">getStats</a></li><li><a href="global.html#getUrlDetails">getUrlDetails</a></li><li><a href="global.html#getUrlSeed">getUrlSeed</a></li><li><a href="global.html#getUrlStats">getUrlStats</a></li><li><a href="global.html#handler">handler</a></li><li><a href="global.html#infiniteScroll">infiniteScroll</a></li><li><a href="global.html#isUrlAllowed">isUrlAllowed</a></li><li><a href="global.html#isUrlAllowedWithRobots">isUrlAllowedWithRobots</a></li><li><a href="global.html#logProgress">logProgress</a></li><li><a href="global.html#main">main</a></li><li><a href="global.html#parseRobotsTxt">parseRobotsTxt</a></li><li><a href="global.html#processOnClickEvents">processOnClickEvents</a></li><li><a href="global.html#processOnclick">processOnclick</a></li><li><a href="global.html#resetFailedVisitsForDomain">resetFailedVisitsForDomain</a></li><li><a href="global.html#resetVisitedStatus">resetVisitedStatus</a></li><li><a href="global.html#resetVisitedStatusForDomain">resetVisitedStatusForDomain</a></li><li><a href="global.html#runCrawler">runCrawler</a></li><li><a href="global.html#saveJobToMySql">saveJobToMySql</a></li><li><a href="global.html#saveSeedsToMongoDB">saveSeedsToMongoDB</a></li><li><a href="global.html#scrollToBottom">scrollToBottom</a></li><li><a href="global.html#updateVisitResultDomains">updateVisitResultDomains</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">scripts/updateDomains.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * 모든 VisitResult 문서의 도메인 필드를 suburl_list 내 URL을 기준으로 업데이트하는 스크립트
 */
require('module-alias/register');
const { VisitResult, extractDomain } = require('@models/visitResult');
const mongoose = require('mongoose');
const { mongoService } = require('@database/mongodb-service');
const { defaultLogger: logger } = require('@utils/logger');

// 업데이트 진행 상황 추적을 위한 변수
let processedDocuments = 0;
let updatedDocuments = 0;
let processedSubUrls = 0;
let updatedSubUrls = 0;
let skippedDocuments = 0;
let errorDocuments = 0;

/**
 * VisitResult 문서의 도메인 필드를 업데이트하는 함수
 * suburl_list 내 URL을 기준으로 도메인을 추출하고 저장합니다.
 */
async function updateVisitResultDomains() {
  try {
    logger.info('VisitResult 문서의 도메인 업데이트 시작...');

    // 총 문서 수 파악
    const totalDocuments = await VisitResult.countDocuments();
    logger.info(`총 ${totalDocuments}개의 VisitResult 문서가 있습니다.`);

    // 모든 문서를 배치 처리 (메모리 효율성을 위해)
    const batchSize = 100; // 한 번에 처리할 문서 수
    let processed = 0;

    // 페이지네이션으로 모든 문서 처리
    while (processed &lt; totalDocuments) {
      const visitResults = await VisitResult.find({})
        .skip(processed)
        .limit(batchSize);

      if (visitResults.length === 0) break;

      // 각 문서 처리
      for (const visitResult of visitResults) {
        try {
          processedDocuments++;
          let documentUpdated = false;

          // suburl_list 배열의 각 항목 처리 및 문서 도메인 결정
          if (visitResult.suburl_list &amp;&amp; visitResult.suburl_list.length > 0) {
            // 도메인별 URL 카운트를 위한 객체
            const domainCounts = {};
            let subUrlsUpdated = false;

            // 1단계: 모든 subUrl의 도메인 추출 및 카운트
            for (const subUrl of visitResult.suburl_list) {
              processedSubUrls++;

              if (subUrl.url) {
                const extractedDomain = extractDomain(subUrl.url);

                if (extractedDomain) {
                  // 도메인 카운트 증가
                  if (!domainCounts[extractedDomain]) {
                    domainCounts[extractedDomain] = 0;
                  }
                  domainCounts[extractedDomain]++;

                  // subUrl 항목의 도메인 필드 업데이트
                  if (subUrl.domain !== extractedDomain) {
                    subUrl.domain = extractedDomain;
                    updatedSubUrls++;
                    subUrlsUpdated = true;
                  }
                }
              }
            }

            // 2단계: 가장 많이 등장한 도메인을 문서의 도메인으로 설정
            if (Object.keys(domainCounts).length > 0) {
              let mostFrequentDomain = null;
              let highestCount = 0;

              for (const [domain, count] of Object.entries(domainCounts)) {
                if (count > highestCount) {
                  highestCount = count;
                  mostFrequentDomain = domain;
                }
              }

              // 문서의 도메인 업데이트
              if (mostFrequentDomain &amp;&amp; visitResult.domain !== mostFrequentDomain) {
                logger.debug(`문서 ID ${visitResult._id}의 도메인 업데이트: ${visitResult.domain || '없음'} -> ${mostFrequentDomain}`);
                visitResult.domain = mostFrequentDomain;
                documentUpdated = true;
              }
            }

            // suburl_list가 수정됐음을 표시
            if (subUrlsUpdated) {
              visitResult.markModified('suburl_list');
              documentUpdated = true;
            }
          }

          // 변경 사항이 있는 경우만 저장
          if (documentUpdated) {
            visitResult.updated_at = new Date();
            await visitResult.save();
            updatedDocuments++;
            logger.debug(`문서 ID ${visitResult._id} 업데이트 완료`);
          } else {
            skippedDocuments++;
          }
        } catch (docError) {
          errorDocuments++;
          logger.error(`문서 ID ${visitResult._id} 처리 중 오류:`, docError);
        }

        // 진행 상황 로깅 (100개마다)
        if (processedDocuments % 100 === 0) {
          logger.info(`진행 상황: ${processedDocuments}/${totalDocuments} 문서 처리 (${Math.round(processedDocuments/totalDocuments*100)}%)`);
          logProgress();
        }
      }

      processed += visitResults.length;
    }

    logger.info('VisitResult 문서의 도메인 업데이트 완료!');
    logProgress();

  } catch (error) {
    logger.error('도메인 업데이트 처리 중 오류 발생:', error);
  }
}

/**
 * 진행 상황 로깅
 */
function logProgress() {
  logger.info(`
처리 통계:
- 처리된 문서: ${processedDocuments}
- 업데이트된 문서: ${updatedDocuments}
- 처리된 SubUrl 항목: ${processedSubUrls}
- 업데이트된 SubUrl 항목: ${updatedSubUrls}
- 건너뛴 문서 (변경 없음): ${skippedDocuments}
- 오류 발생 문서: ${errorDocuments}
  `);
}

/**
 * 메인 함수
 */
async function main() {
  try {
    logger.info('도메인 업데이트 작업 시작...');

    // 데이터베이스 연결
    await mongoService.connect();
    logger.info('MongoDB에 연결되었습니다.');

    // VisitResult 문서 업데이트
    await updateVisitResultDomains();

    logger.info('모든 도메인 업데이트 작업이 완료되었습니다!');
  } catch (error) {
    logger.error('도메인 업데이트 작업 중 오류 발생:', error);
  } finally {
    // 데이터베이스 연결 종료
    await mongoose.connection.close();
    logger.info('MongoDB 연결을 종료했습니다.');
  }
}

// 스크립트 실행
main().catch(err => {
  logger.error('스크립트 실행 중 처리되지 않은 오류:', err);
  process.exit(1);
});</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.4</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
