<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>crawl/urlManager.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BaseWorkerManager.html">BaseWorkerManager</a><ul class='methods'><li data-type='method'><a href="BaseWorkerManager.html#closeBrowser">closeBrowser</a></li><li data-type='method'><a href="BaseWorkerManager.html#connect">connect</a></li><li data-type='method'><a href="BaseWorkerManager.html#disconnect">disconnect</a></li><li data-type='method'><a href="BaseWorkerManager.html#extractLinks">extractLinks</a></li><li data-type='method'><a href="BaseWorkerManager.html#extractPageContent">extractPageContent</a></li><li data-type='method'><a href="BaseWorkerManager.html#filterAllowedUrls">filterAllowedUrls</a></li><li data-type='method'><a href="BaseWorkerManager.html#getNextUrl">getNextUrl</a></li><li data-type='method'><a href="BaseWorkerManager.html#getUrlForDomain">getUrlForDomain</a></li><li data-type='method'><a href="BaseWorkerManager.html#groupUrlsByDomain">groupUrlsByDomain</a></li><li data-type='method'><a href="BaseWorkerManager.html#handleDomainError">handleDomainError</a></li><li data-type='method'><a href="BaseWorkerManager.html#initAvailableDomains">initAvailableDomains</a></li><li data-type='method'><a href="BaseWorkerManager.html#initBrowser">initBrowser</a></li><li data-type='method'><a href="BaseWorkerManager.html#processQueue">processQueue</a></li><li data-type='method'><a href="BaseWorkerManager.html#run">run</a></li><li data-type='method'><a href="BaseWorkerManager.html#saveErrorScreenshot">saveErrorScreenshot</a></li><li data-type='method'><a href="BaseWorkerManager.html#saveVisitResult">saveVisitResult</a></li><li data-type='method'><a href="BaseWorkerManager.html#selectTargetDomain">selectTargetDomain</a></li><li data-type='method'><a href="BaseWorkerManager.html#tryNextDomain">tryNextDomain</a></li><li data-type='method'><a href="BaseWorkerManager.html#visitUrl">visitUrl</a></li></ul></li><li><a href="ClaudeParser.html">ClaudeParser</a><ul class='methods'><li data-type='method'><a href="ClaudeParser.html#connect">connect</a></li><li data-type='method'><a href="ClaudeParser.html#convertToRecruitInfoSchema">convertToRecruitInfoSchema</a></li><li data-type='method'><a href="ClaudeParser.html#fetchRecruitUrls">fetchRecruitUrls</a></li><li data-type='method'><a href="ClaudeParser.html#processUrl">processUrl</a></li><li data-type='method'><a href="ClaudeParser.html#requestUrlParse">requestUrlParse</a></li><li data-type='method'><a href="ClaudeParser.html#run">run</a></li><li data-type='method'><a href="ClaudeParser.html#saveRecruitInfo">saveRecruitInfo</a></li><li data-type='method'><a href="ClaudeParser.html#wait">wait</a></li></ul></li><li><a href="ClaudeService.html">ClaudeService</a><ul class='methods'><li data-type='method'><a href="ClaudeService.html#generateContent">generateContent</a></li><li data-type='method'><a href="ClaudeService.html#getRecruitmentPrompt">getRecruitmentPrompt</a></li><li data-type='method'><a href="ClaudeService.html#getStatus">getStatus</a></li><li data-type='method'><a href="ClaudeService.html#initializeClient">initializeClient</a></li></ul></li><li><a href="GeminiService.html">GeminiService</a><ul class='methods'><li data-type='method'><a href="GeminiService.html#generateContent">generateContent</a></li><li data-type='method'><a href="GeminiService.html#getKeyStatus">getKeyStatus</a></li><li data-type='method'><a href="GeminiService.html#getRecruitmentPrompt">getRecruitmentPrompt</a></li><li data-type='method'><a href="GeminiService.html#getRecruitmentSchema">getRecruitmentSchema</a></li><li data-type='method'><a href="GeminiService.html#initializeClient">initializeClient</a></li><li data-type='method'><a href="GeminiService.html#parseRecruitment">parseRecruitment</a></li><li data-type='method'><a href="GeminiService.html#rotateApiKey">rotateApiKey</a></li></ul></li><li><a href="Logger.html">Logger</a><ul class='methods'><li data-type='method'><a href="Logger.html#checkLogFileDate">checkLogFileDate</a></li><li data-type='method'><a href="Logger.html#colorize">colorize</a></li><li data-type='method'><a href="Logger.html#formatJsonMessage">formatJsonMessage</a></li><li data-type='method'><a href="Logger.html#formatJsonMessage">formatJsonMessage</a></li><li data-type='method'><a href="Logger.html#formatTextMessage">formatTextMessage</a></li><li data-type='method'><a href="Logger.html#log">log</a></li><li data-type='method'><a href="Logger.html#logEvent">logEvent</a></li><li data-type='method'><a href="Logger.html#setupLogFiles">setupLogFiles</a></li><li data-type='method'><a href="Logger.html#setupLogRotation">setupLogRotation</a></li></ul></li><li><a href="MongoDBService.html">MongoDBService</a><ul class='methods'><li data-type='method'><a href="MongoDBService.html#connect">connect</a></li><li data-type='method'><a href="MongoDBService.html#disconnect">disconnect</a></li><li data-type='method'><a href="MongoDBService.html#getConnection">getConnection</a></li><li data-type='method'><a href="MongoDBService.html#getConnectionStatus">getConnectionStatus</a></li><li data-type='method'><a href="MongoDBService.html#getMongoose">getMongoose</a></li><li data-type='method'><a href="MongoDBService.html#setDbName">setDbName</a></li><li data-type='method'><a href="MongoDBService.html#setUri">setUri</a></li></ul></li><li><a href="OnClickWorker.html">OnClickWorker</a><ul class='methods'><li data-type='method'><a href="OnClickWorker.html#checkUrlChanges">checkUrlChanges</a></li><li data-type='method'><a href="OnClickWorker.html#cleanup">cleanup</a></li><li data-type='method'><a href="OnClickWorker.html#execute">execute</a></li><li data-type='method'><a href="OnClickWorker.html#formatResult">formatResult</a></li><li data-type='method'><a href="OnClickWorker.html#initialize">initialize</a></li><li data-type='method'><a href="OnClickWorker.html#scrollFullPage">scrollFullPage</a></li><li data-type='method'><a href="OnClickWorker.html#scrollPage">scrollPage</a></li><li data-type='method'><a href="OnClickWorker.html#setupPage">setupPage</a></li></ul></li><li><a href="ParseManager.html">ParseManager</a><ul class='methods'><li data-type='method'><a href="ParseManager.html#cancel">cancel</a></li><li data-type='method'><a href="ParseManager.html#connect">connect</a></li><li data-type='method'><a href="ParseManager.html#convertToRecruitInfoSchema">convertToRecruitInfoSchema</a></li><li data-type='method'><a href="ParseManager.html#fetchUnclassifiedUrls">fetchUnclassifiedUrls</a></li><li data-type='method'><a href="ParseManager.html#getStatus">getStatus</a></li><li data-type='method'><a href="ParseManager.html#processUrl">processUrl</a></li><li data-type='method'><a href="ParseManager.html#requestUrlParse">requestUrlParse</a></li><li data-type='method'><a href="ParseManager.html#run">run</a></li><li data-type='method'><a href="ParseManager.html#saveRecruitInfo">saveRecruitInfo</a></li><li data-type='method'><a href="ParseManager.html#wait">wait</a></li></ul></li><li><a href="RecruitInfoDbService.html">RecruitInfoDbService</a><ul class='methods'><li data-type='method'><a href="RecruitInfoDbService.html#bulkCreateOrUpdate">bulkCreateOrUpdate</a></li><li data-type='method'><a href="RecruitInfoDbService.html#bulkDelete">bulkDelete</a></li><li data-type='method'><a href="RecruitInfoDbService.html#createOrUpdate">createOrUpdate</a></li><li data-type='method'><a href="RecruitInfoDbService.html#deleteByUrl">deleteByUrl</a></li><li data-type='method'><a href="RecruitInfoDbService.html#deleteExpired">deleteExpired</a></li><li data-type='method'><a href="RecruitInfoDbService.html#getAll">getAll</a></li><li data-type='method'><a href="RecruitInfoDbService.html#getByUrl">getByUrl</a></li><li data-type='method'><a href="RecruitInfoDbService.html#getStats">getStats</a></li><li data-type='method'><a href="RecruitInfoDbService.html#search">search</a></li><li data-type='method'><a href="RecruitInfoDbService.html#searchByKeywords">searchByKeywords</a></li></ul></li><li><a href="WorkerPool.html">WorkerPool</a><ul class='methods'><li data-type='method'><a href="WorkerPool.html#enqueue">enqueue</a></li><li data-type='method'><a href="WorkerPool.html#processQueue">processQueue</a></li><li data-type='method'><a href="WorkerPool.html#processTasks">processTasks</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#RecruitInfo">RecruitInfo</a></li><li><a href="global.html#createTableIfNotExists">createTableIfNotExists</a></li><li><a href="global.html#extractAndExecuteScripts">extractAndExecuteScripts</a></li><li><a href="global.html#extractAndProcessOnClicks">extractAndProcessOnClicks</a></li><li><a href="global.html#extractDomain">extractDomain</a></li><li><a href="global.html#getClaudeJobById">getClaudeJobById</a></li><li><a href="global.html#getClaudeJobFilters">getClaudeJobFilters</a></li><li><a href="global.html#getClaudeJobStats">getClaudeJobStats</a></li><li><a href="global.html#getClaudeJobs">getClaudeJobs</a></li><li><a href="global.html#getCompleteClaudeJobs">getCompleteClaudeJobs</a></li><li><a href="global.html#getCompletionStats">getCompletionStats</a></li><li><a href="global.html#getDomainStats">getDomainStats</a></li><li><a href="global.html#getExperienceStats">getExperienceStats</a></li><li><a href="global.html#getFailedVisitStats">getFailedVisitStats</a></li><li><a href="global.html#getJobById">getJobById</a></li><li><a href="global.html#getJobTypeStats">getJobTypeStats</a></li><li><a href="global.html#getJobs">getJobs</a></li><li><a href="global.html#getMySqlJobFilters">getMySqlJobFilters</a></li><li><a href="global.html#getMySqlJobs">getMySqlJobs</a></li><li><a href="global.html#getResults">getResults</a></li><li><a href="global.html#getStats">getStats</a></li><li><a href="global.html#getUrlDetails">getUrlDetails</a></li><li><a href="global.html#getUrlSeed">getUrlSeed</a></li><li><a href="global.html#getUrlStats">getUrlStats</a></li><li><a href="global.html#handler">handler</a></li><li><a href="global.html#infiniteScroll">infiniteScroll</a></li><li><a href="global.html#isUrlAllowed">isUrlAllowed</a></li><li><a href="global.html#isUrlAllowedWithRobots">isUrlAllowedWithRobots</a></li><li><a href="global.html#logProgress">logProgress</a></li><li><a href="global.html#main">main</a></li><li><a href="global.html#parseRobotsTxt">parseRobotsTxt</a></li><li><a href="global.html#processOnClickEvents">processOnClickEvents</a></li><li><a href="global.html#processOnclick">processOnclick</a></li><li><a href="global.html#resetFailedVisitsForDomain">resetFailedVisitsForDomain</a></li><li><a href="global.html#resetVisitedStatus">resetVisitedStatus</a></li><li><a href="global.html#resetVisitedStatusForDomain">resetVisitedStatusForDomain</a></li><li><a href="global.html#runCrawler">runCrawler</a></li><li><a href="global.html#saveJobToMySql">saveJobToMySql</a></li><li><a href="global.html#saveSeedsToMongoDB">saveSeedsToMongoDB</a></li><li><a href="global.html#scrollToBottom">scrollToBottom</a></li><li><a href="global.html#updateVisitResultDomains">updateVisitResultDomains</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">crawl/urlManager.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const { defaultLogger: logger } = require('@utils/logger');
const RobotsParser = require('robots-parser');
// node-fetch v2를 사용하는 경우: const fetch = require('node-fetch');
// Node.js 18+ 에서는 내장 fetch 사용 가능, 또는 node-fetch v3 (ESM) 사용 시 import 방식 사용
// 예시에서는 Node.js 18+ 내장 fetch 또는 전역 fetch가 있다고 가정합니다.
// 만약 node-fetch v2 (CommonJS)를 사용한다면 위에 주석 처리된 라인을 활성화하세요.

/**
 * 주어진 URL이 허용된 도메인에 속하는지 확인합니다.
 * @param {string} url - 확인할 URL
 * @param {string[]} allowedDomains - 허용된 도메인 목록
 * @returns {boolean} - URL이 허용되면 true, 그렇지 않으면 false
 */
function isUrlAllowed(url, allowedDomains) {
  try {
    // URL이 유효한지 검증
    const parsedUrl = new URL(url);

    // 지원되는 프로토콜인지 확인 (http 또는 https만 허용)
    if (parsedUrl.protocol !== 'http:' &amp;&amp; parsedUrl.protocol !== 'https:') {
      logger.debug(`Unsupported protocol: ${parsedUrl.protocol} in URL: ${url}`);
      return false;
    }

    // 도메인 추출
    const domain = parsedUrl.hostname; // host 대신 hostname 사용 (포트 번호 제외)
    // 허용된 도메인인지 확인
    return allowedDomains.some(allowedDomain =>
      domain === allowedDomain ||
      domain.endsWith(`.${allowedDomain}`)
    );
  } catch (error) {
    // URL 파싱에 실패하면 (잘못된 URL 형식) false 반환
    logger.debug(`Invalid URL format: ${url}`, error);
    return false;
  }
}

/**
 * URL에서 도메인 추출
 * @param {string} url URL
 * @returns {string | null} 도메인 또는 null
 */
function extractDomain(url) {
  try {
    const urlObj = new URL(url);
    return urlObj.hostname; // host 대신 hostname 사용 (포트 번호 제외)
  } catch (error) {
    logger.debug(`URL에서 도메인 추출 중 오류: ${url}`, error);
    return null;
  }
}

/**
 * robots.txt 파일을 가져와서 파싱하고 규칙 객체 반환
 * @param {string} domain 도메인 이름
 * @returns {Promise&lt;Object>} 파싱 결과 객체 { domain, url, parser, success, error? }
 */
async function parseRobotsTxt(domain) {
  const startTime = Date.now();
  // robots.txt는 http/https 모두 가능하나, 일반적으로 https 우선 시도
  const protocols = ['https', 'http'];
  let robotsUrl = '';
  let response = null;
  let robotsContent = '';
  let success = false;
  let fetchError = null;

  for (const protocol of protocols) {
    robotsUrl = `${protocol}://${domain}/robots.txt`;
    try {
      logger.debug(`Trying to fetch robots.txt from: ${robotsUrl}`);
      response = await fetch(robotsUrl, {
        method: 'GET',
        headers: {
          'User-Agent': 'YourBotName/1.0 (+http://yourwebsite.com/botinfo)' // 적절한 User-Agent 설정 권장
        },
        // 필요에 따라 timeout 설정
        // signal: AbortSignal.timeout(10000) // 예: 10초 타임아웃 (Node.js 16+)
      });

      if (response.ok) {
        robotsContent = await response.text();
        success = true;
        logger.debug(`${domain}의 robots.txt 가져오기 성공 (${robotsUrl})`);
        break; // 성공 시 루프 종료
      } else if (response.status === 404) {
        logger.debug(`${domain}의 robots.txt 찾을 수 없음 (404) (${robotsUrl}). 모든 경로 허용으로 간주.`);
        // robots.txt가 없으면 모든 경로 허용이 일반적 규칙
        robotsContent = ''; // 빈 내용 전달
        success = true; // 파일을 못 찾은 것도 '파싱 관점'에서는 처리 가능한 상태
        fetchError = new Error(`File not found (404)`); // 에러 정보 기록
        break; // 404 확인 후 종료 (http 재시도 불필요)
      } else {
        logger.debug(`${domain}의 robots.txt 가져오기 실패 (${robotsUrl}): Status ${response.status}`);
        fetchError = new Error(`Failed to fetch robots.txt: Status ${response.status}`);
        // 다른 프로토콜로 재시도하기 위해 루프 계속
      }
    } catch (error) {
      logger.debug(`${domain}의 robots.txt 가져오기 중 네트워크 오류 (${robotsUrl}):`, error.message);
      fetchError = error;
      // 다른 프로토콜로 재시도하기 위해 루프 계속
    }
  }


  let parser = null;

  try {
    // fetch 성공 여부와 관계없이 parser 인스턴스 생성 시도
    // fetch 실패 시 robotsContent는 '' (빈 문자열) 이므로, 기본적으로 모든 것을 허용하는 파서 생성
    parser = RobotsParser(robotsUrl || `https://${domain}/robots.txt`, robotsContent); // URL과 내용을 전달
    const runtime = Date.now() - startTime;
    if (success) {
      logger.debug(`${domain}의 robots.txt 파싱 완료`);
      logger.eventInfo('parse_robot_txt', { domain, runtime });
       // fetch가 성공했으므로 파싱 결과 반환
       return {
         domain,
         url: robotsUrl,
         parser,
         success: true,
         runtime,
       };
    } else {
      // fetch 실패 시 (네트워크 오류 또는 404 외 다른 상태 코드)
      logger.eventError('parse_robot_txt', { domain, robotsUrl: robotsUrl || `https://${domain}/robots.txt`, runtime, error: fetchError?.message || 'Unknown fetch error' });
      return {
        domain,
        url: robotsUrl || `https://${domain}/robots.txt`, // 시도했던 마지막 URL 또는 기본 URL
        parser, // 빈 내용으로 생성된 기본 파서 (모든 것 허용)
        success: false, // 가져오기/파싱 과정에서 문제가 있었음을 명시
        error: fetchError?.message || 'Unknown fetch error',
        runtime,
      };
    }
  } catch (parseError) {
    // RobotsParser 생성자 자체에서 오류가 발생한 경우 (매우 드묾)
    logger.debug(`robots.txt 파싱 중 예외 발생 (${domain}):`, parseError);
    logger.eventError('parse_robot_txt', { domain, error: parseError.message, runtime });
    return {
      domain,
      success: false,
      error: `Parser instantiation error: ${parseError.message}`,
      runtime,
      parser: null, // 파서 생성 실패
    };
  }
}


/**
 * URL이 허용되는지 확인 (robots.txt 규칙 포함)
 * @param {string} url - 확인할 URL
 * @param {Array&lt;string>} allowedDomains - 허용된 도메인 목록
 * @param {Object} robotsCache - 도메인별 robots.txt 캐시
 * @returns {Promise&lt;boolean>} 허용 여부
 */
async function isUrlAllowedWithRobots(url, allowedDomains = [], robotsCache = {}) {
  // 1. 기본 도메인 및 프로토콜 검사
  if (!isUrlAllowed(url, allowedDomains)) {
    logger.debug(`URL ${url} is not in allowed domains or has unsupported protocol.`);
    return false;
  }

  try {
    const domain = extractDomain(url);
    if (!domain) {
      logger.debug(`Could not extract domain from URL: ${url}`);
      return false; // 도메인 추출 실패 시 진행 불가
    }

    // 2. robots.txt 규칙 가져오기 (캐시에 없으면 파싱)
    if (!(domain in robotsCache)) {
       logger.debug(`Robots.txt for domain ${domain} not in cache. Parsing...`);
       robotsCache[domain] = await parseRobotsTxt(domain);
       // 캐싱 결과 로깅 (옵션)
       // logger.debug(`Caching result for ${domain}: success=${robotsCache[domain].success}`);
    } else {
       // logger.debug(`Using cached robots.txt for domain ${domain}`);
    }

    const robotsData = robotsCache[domain];

    // 3. robots.txt 파싱 결과 확인 및 규칙 적용
    // 파서 객체가 없거나 (파싱 중 심각한 오류 발생) 파싱에 실패(success:false)했지만 안전하게 진행하고 싶다면 허용 (선택적)
    // 또는 파싱 실패 시 무조건 차단할 수도 있음. 현재 코드는 파싱 실패 시 기본 파서(모든 것 허용)를 사용함.
    if (!robotsData || !robotsData.parser) {
      logger.debug(`No valid robots data or parser available for domain ${domain}. Allowing URL ${url} by default.`);
      return true; // robots.txt 정보가 없거나 파서 생성 실패 시 기본적으로 허용
    }

    // robots.txt 규칙에 따라 URL 허용 여부 확인 (User-Agent 지정 필수)
    const userAgent = 'puppeteer'; // 또는 사용하는 실제 User-Agent
    const isAllowed = robotsData.parser.isAllowed(url, userAgent);

    if (!isAllowed) {
      logger.debug(`URL ${url} is disallowed by robots.txt for domain ${domain} (User-Agent: ${userAgent})`);
    } else {
      // logger.debug(`URL ${url} is allowed by robots.txt for domain ${domain} (User-Agent: ${userAgent})`);
    }

    return isAllowed;

  } catch (error) {
    // URL 파싱 오류 등 예상치 못한 오류 처리
    logger.error(`Error checking if URL ${url} is allowed with robots:`, error);
    return true; // 오류 발생 시 안전하게 기본적으로 허용 (또는 false로 변경 가능)
  }
}

module.exports = { isUrlAllowed, extractDomain, parseRobotsTxt, isUrlAllowedWithRobots };</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.4</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
