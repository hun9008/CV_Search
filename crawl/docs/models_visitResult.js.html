<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>models/visitResult.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BaseWorkerManager.html">BaseWorkerManager</a><ul class='methods'><li data-type='method'><a href="BaseWorkerManager.html#closeBrowser">closeBrowser</a></li><li data-type='method'><a href="BaseWorkerManager.html#connect">connect</a></li><li data-type='method'><a href="BaseWorkerManager.html#disconnect">disconnect</a></li><li data-type='method'><a href="BaseWorkerManager.html#extractLinks">extractLinks</a></li><li data-type='method'><a href="BaseWorkerManager.html#extractPageContent">extractPageContent</a></li><li data-type='method'><a href="BaseWorkerManager.html#filterAllowedUrls">filterAllowedUrls</a></li><li data-type='method'><a href="BaseWorkerManager.html#getNextUrl">getNextUrl</a></li><li data-type='method'><a href="BaseWorkerManager.html#getUrlForDomain">getUrlForDomain</a></li><li data-type='method'><a href="BaseWorkerManager.html#groupUrlsByDomain">groupUrlsByDomain</a></li><li data-type='method'><a href="BaseWorkerManager.html#handleDomainError">handleDomainError</a></li><li data-type='method'><a href="BaseWorkerManager.html#initAvailableDomains">initAvailableDomains</a></li><li data-type='method'><a href="BaseWorkerManager.html#initBrowser">initBrowser</a></li><li data-type='method'><a href="BaseWorkerManager.html#processQueue">processQueue</a></li><li data-type='method'><a href="BaseWorkerManager.html#run">run</a></li><li data-type='method'><a href="BaseWorkerManager.html#saveErrorScreenshot">saveErrorScreenshot</a></li><li data-type='method'><a href="BaseWorkerManager.html#saveVisitResult">saveVisitResult</a></li><li data-type='method'><a href="BaseWorkerManager.html#selectTargetDomain">selectTargetDomain</a></li><li data-type='method'><a href="BaseWorkerManager.html#tryNextDomain">tryNextDomain</a></li><li data-type='method'><a href="BaseWorkerManager.html#visitUrl">visitUrl</a></li></ul></li><li><a href="ClaudeParser.html">ClaudeParser</a><ul class='methods'><li data-type='method'><a href="ClaudeParser.html#connect">connect</a></li><li data-type='method'><a href="ClaudeParser.html#convertToRecruitInfoSchema">convertToRecruitInfoSchema</a></li><li data-type='method'><a href="ClaudeParser.html#fetchRecruitUrls">fetchRecruitUrls</a></li><li data-type='method'><a href="ClaudeParser.html#processUrl">processUrl</a></li><li data-type='method'><a href="ClaudeParser.html#requestUrlParse">requestUrlParse</a></li><li data-type='method'><a href="ClaudeParser.html#run">run</a></li><li data-type='method'><a href="ClaudeParser.html#saveRecruitInfo">saveRecruitInfo</a></li><li data-type='method'><a href="ClaudeParser.html#wait">wait</a></li></ul></li><li><a href="ClaudeService.html">ClaudeService</a><ul class='methods'><li data-type='method'><a href="ClaudeService.html#generateContent">generateContent</a></li><li data-type='method'><a href="ClaudeService.html#getRecruitmentPrompt">getRecruitmentPrompt</a></li><li data-type='method'><a href="ClaudeService.html#getStatus">getStatus</a></li><li data-type='method'><a href="ClaudeService.html#initializeClient">initializeClient</a></li></ul></li><li><a href="GeminiService.html">GeminiService</a><ul class='methods'><li data-type='method'><a href="GeminiService.html#generateContent">generateContent</a></li><li data-type='method'><a href="GeminiService.html#getKeyStatus">getKeyStatus</a></li><li data-type='method'><a href="GeminiService.html#getRecruitmentPrompt">getRecruitmentPrompt</a></li><li data-type='method'><a href="GeminiService.html#getRecruitmentSchema">getRecruitmentSchema</a></li><li data-type='method'><a href="GeminiService.html#initializeClient">initializeClient</a></li><li data-type='method'><a href="GeminiService.html#parseRecruitment">parseRecruitment</a></li><li data-type='method'><a href="GeminiService.html#rotateApiKey">rotateApiKey</a></li></ul></li><li><a href="Logger.html">Logger</a><ul class='methods'><li data-type='method'><a href="Logger.html#checkLogFileDate">checkLogFileDate</a></li><li data-type='method'><a href="Logger.html#colorize">colorize</a></li><li data-type='method'><a href="Logger.html#formatJsonMessage">formatJsonMessage</a></li><li data-type='method'><a href="Logger.html#formatJsonMessage">formatJsonMessage</a></li><li data-type='method'><a href="Logger.html#formatTextMessage">formatTextMessage</a></li><li data-type='method'><a href="Logger.html#log">log</a></li><li data-type='method'><a href="Logger.html#logEvent">logEvent</a></li><li data-type='method'><a href="Logger.html#setupLogFiles">setupLogFiles</a></li><li data-type='method'><a href="Logger.html#setupLogRotation">setupLogRotation</a></li></ul></li><li><a href="MongoDBService.html">MongoDBService</a><ul class='methods'><li data-type='method'><a href="MongoDBService.html#connect">connect</a></li><li data-type='method'><a href="MongoDBService.html#disconnect">disconnect</a></li><li data-type='method'><a href="MongoDBService.html#getConnection">getConnection</a></li><li data-type='method'><a href="MongoDBService.html#getConnectionStatus">getConnectionStatus</a></li><li data-type='method'><a href="MongoDBService.html#getMongoose">getMongoose</a></li><li data-type='method'><a href="MongoDBService.html#setDbName">setDbName</a></li><li data-type='method'><a href="MongoDBService.html#setUri">setUri</a></li></ul></li><li><a href="OnClickWorker.html">OnClickWorker</a><ul class='methods'><li data-type='method'><a href="OnClickWorker.html#checkUrlChanges">checkUrlChanges</a></li><li data-type='method'><a href="OnClickWorker.html#cleanup">cleanup</a></li><li data-type='method'><a href="OnClickWorker.html#execute">execute</a></li><li data-type='method'><a href="OnClickWorker.html#formatResult">formatResult</a></li><li data-type='method'><a href="OnClickWorker.html#initialize">initialize</a></li><li data-type='method'><a href="OnClickWorker.html#scrollFullPage">scrollFullPage</a></li><li data-type='method'><a href="OnClickWorker.html#scrollPage">scrollPage</a></li><li data-type='method'><a href="OnClickWorker.html#setupPage">setupPage</a></li></ul></li><li><a href="ParseManager.html">ParseManager</a><ul class='methods'><li data-type='method'><a href="ParseManager.html#cancel">cancel</a></li><li data-type='method'><a href="ParseManager.html#connect">connect</a></li><li data-type='method'><a href="ParseManager.html#convertToRecruitInfoSchema">convertToRecruitInfoSchema</a></li><li data-type='method'><a href="ParseManager.html#fetchUnclassifiedUrls">fetchUnclassifiedUrls</a></li><li data-type='method'><a href="ParseManager.html#getStatus">getStatus</a></li><li data-type='method'><a href="ParseManager.html#processUrl">processUrl</a></li><li data-type='method'><a href="ParseManager.html#requestUrlParse">requestUrlParse</a></li><li data-type='method'><a href="ParseManager.html#run">run</a></li><li data-type='method'><a href="ParseManager.html#saveRecruitInfo">saveRecruitInfo</a></li><li data-type='method'><a href="ParseManager.html#wait">wait</a></li></ul></li><li><a href="RecruitInfoDbService.html">RecruitInfoDbService</a><ul class='methods'><li data-type='method'><a href="RecruitInfoDbService.html#bulkCreateOrUpdate">bulkCreateOrUpdate</a></li><li data-type='method'><a href="RecruitInfoDbService.html#bulkDelete">bulkDelete</a></li><li data-type='method'><a href="RecruitInfoDbService.html#createOrUpdate">createOrUpdate</a></li><li data-type='method'><a href="RecruitInfoDbService.html#deleteByUrl">deleteByUrl</a></li><li data-type='method'><a href="RecruitInfoDbService.html#deleteExpired">deleteExpired</a></li><li data-type='method'><a href="RecruitInfoDbService.html#getAll">getAll</a></li><li data-type='method'><a href="RecruitInfoDbService.html#getByUrl">getByUrl</a></li><li data-type='method'><a href="RecruitInfoDbService.html#getStats">getStats</a></li><li data-type='method'><a href="RecruitInfoDbService.html#search">search</a></li><li data-type='method'><a href="RecruitInfoDbService.html#searchByKeywords">searchByKeywords</a></li></ul></li><li><a href="WorkerPool.html">WorkerPool</a><ul class='methods'><li data-type='method'><a href="WorkerPool.html#enqueue">enqueue</a></li><li data-type='method'><a href="WorkerPool.html#processQueue">processQueue</a></li><li data-type='method'><a href="WorkerPool.html#processTasks">processTasks</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#RecruitInfo">RecruitInfo</a></li><li><a href="global.html#createTableIfNotExists">createTableIfNotExists</a></li><li><a href="global.html#extractAndExecuteScripts">extractAndExecuteScripts</a></li><li><a href="global.html#extractAndProcessOnClicks">extractAndProcessOnClicks</a></li><li><a href="global.html#extractDomain">extractDomain</a></li><li><a href="global.html#getClaudeJobById">getClaudeJobById</a></li><li><a href="global.html#getClaudeJobFilters">getClaudeJobFilters</a></li><li><a href="global.html#getClaudeJobStats">getClaudeJobStats</a></li><li><a href="global.html#getClaudeJobs">getClaudeJobs</a></li><li><a href="global.html#getCompleteClaudeJobs">getCompleteClaudeJobs</a></li><li><a href="global.html#getCompletionStats">getCompletionStats</a></li><li><a href="global.html#getDomainStats">getDomainStats</a></li><li><a href="global.html#getExperienceStats">getExperienceStats</a></li><li><a href="global.html#getFailedVisitStats">getFailedVisitStats</a></li><li><a href="global.html#getJobById">getJobById</a></li><li><a href="global.html#getJobTypeStats">getJobTypeStats</a></li><li><a href="global.html#getJobs">getJobs</a></li><li><a href="global.html#getMySqlJobFilters">getMySqlJobFilters</a></li><li><a href="global.html#getMySqlJobs">getMySqlJobs</a></li><li><a href="global.html#getResults">getResults</a></li><li><a href="global.html#getStats">getStats</a></li><li><a href="global.html#getUrlDetails">getUrlDetails</a></li><li><a href="global.html#getUrlSeed">getUrlSeed</a></li><li><a href="global.html#getUrlStats">getUrlStats</a></li><li><a href="global.html#handler">handler</a></li><li><a href="global.html#infiniteScroll">infiniteScroll</a></li><li><a href="global.html#isUrlAllowed">isUrlAllowed</a></li><li><a href="global.html#isUrlAllowedWithRobots">isUrlAllowedWithRobots</a></li><li><a href="global.html#logProgress">logProgress</a></li><li><a href="global.html#main">main</a></li><li><a href="global.html#parseRobotsTxt">parseRobotsTxt</a></li><li><a href="global.html#processOnClickEvents">processOnClickEvents</a></li><li><a href="global.html#processOnclick">processOnclick</a></li><li><a href="global.html#resetFailedVisitsForDomain">resetFailedVisitsForDomain</a></li><li><a href="global.html#resetVisitedStatus">resetVisitedStatus</a></li><li><a href="global.html#resetVisitedStatusForDomain">resetVisitedStatusForDomain</a></li><li><a href="global.html#runCrawler">runCrawler</a></li><li><a href="global.html#saveJobToMySql">saveJobToMySql</a></li><li><a href="global.html#saveSeedsToMongoDB">saveSeedsToMongoDB</a></li><li><a href="global.html#scrollToBottom">scrollToBottom</a></li><li><a href="global.html#updateVisitResultDomains">updateVisitResultDomains</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">models/visitResult.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const mongoose = require('mongoose');
const Table = require('cli-table3');
const Schema = mongoose.Schema;

// URL 항목 서브스키마 (suburl_list 배열의 항목)
const SubUrlSchema = new Schema({
  url: {
    type: String,
    required: true
  },
  visited: {
    type: Boolean,
    default: false
  },
  visitedAt: Date,
  discoveredAt: Date,
  created_at: {
    type: Date,
    default: Date.now
  },
  updated_at: {
    type: Date,
    default: Date.now
  },
  isRecruit: Boolean,
  isRecruit_claude : Boolean,
  success: Boolean,
  error: String,
  errors:[{
    type: { type: String },
    message: String,
    stack: String,
    url: String
  }],
  finalUrl: String,
  text: String,
  title: String,
  meta: Schema.Types.Mixed,
  crawlStats: {
    blocked_by_robots: Number,
    allowed_after_robots:Number,
    total: Number,
    href: Number,
    onclick: Number
  },
  domain: String,
  redirected: Boolean,
  crawledUrls: { type: [String], default: [] } //

});


/**
 * SubUrl 항목의 상세 정보를 테이블 형식으로 로깅
 * @param {Object} logger - 로깅에 사용할 로거 객체
 * @returns {void}
 */
SubUrlSchema.methods.logSummary = function(logger) {
  try {
    if (!logger) {
      console.warn('로거가 제공되지 않았습니다. 기본 콘솔을 사용합니다.');
      logger = console;
    }

    // URL 기본 정보
    logger.info(`\nURL 항목 요약 정보:`);

    // const basicInfo = {
    //   URL: this.url,
    //   도메인: this.domain || extractDomain(this.url),
    //   제목: this.title || '제목 없음',
    //   내용: this.text || '내용 없음',
    //   방문여부: this.visited ? '방문함' : '방문하지 않음',
    //   성공여부: this.success ? '성공' : this.visited ? '실패' : '미방문',
    //   리다이렉트: this.redirected ? `${this.url} → ${this.finalUrl}` : '없음',
    //   방문시간: this.visitedAt ? new Date(this.visitedAt).toLocaleString() : '없음',
    //   발견시간: this.discoveredAt ? new Date(this.discoveredAt).toLocaleString() : new Date(this.created_at).toLocaleString(),
    //   생성시간: new Date(this.created_at).toLocaleString(),
    //   수정시간: new Date(this.updated_at).toLocaleString()
    // };

    // console.table(basicInfo);
    // 커스텀 테이블 생성
const table = new Table({
  head: ['항목', '값'],
  colWidths: [15, 65], // 열 너비 고정
  wordWrap: true       // 긴 텍스트 자동 줄바꿈
});

    // 데이터 추가
    table.push(
      ['URL', this.url],
      ['도메인', this.domain || extractDomain(this.url)],
      ['제목', this.title || '제목 없음'],
      ['방문여부', this.visited ? '방문함' : '방문하지 않음'],
      ['성공여부', this.success ? '성공' : this.visited ? '실패' : '미방문'],
      ['리다이렉트', this.redirected ? `${this.url} → ${this.finalUrl}` : '없음'],
      ['방문시간', this.visitedAt ? new Date(this.visitedAt).toLocaleString() : '없음'],
      ['발견시간', this.discoveredAt ? new Date(this.discoveredAt).toLocaleString() : new Date(this.created_at).toLocaleString()],
      ['생성시간', new Date(this.created_at).toLocaleString()],
      ['수정시간', new Date(this.updated_at).toLocaleString()]
    );

    // 내용은 별도 테이블로 처리
    if (this.text) {
      const contentPreview = this.text.length > 200
        ? this.text.substring(0, 197) + '...'
        : this.text;

      table.push(['내용 미리보기', contentPreview]);
      table.push(['내용 길이', `${this.text.length}자`]);
    }

    // 테이블 출력
    logger.debug(`\nURL 항목 요약 정보:`);
    logger.debug('\n'+table.toString());

    // 크롤링 통계가 있으면 표시
    if (this.crawlStats) {
      const crawlStats = {
        '총 링크 수': this.crawlStats.total || 0,
        'href 링크 수': this.crawlStats.href || 0,
        'onclick 링크 수': this.crawlStats.onclick || 0
      };

      logger.info('크롤링 통계:');
      console.table(crawlStats);
    }

    // 메타 정보가 있으면 표시 (최상위 속성만)
    if (this.meta &amp;&amp; typeof this.meta === 'object') {
      const metaInfo = {};

      // 중첩된 객체는 [Object]로 표시, 배열은 [Array(길이)]로 표시
      Object.keys(this.meta).forEach(key => {
        const value = this.meta[key];
        if (value === null || value === undefined) {
          metaInfo[key] = 'null';
        } else if (typeof value === 'object') {
          if (Array.isArray(value)) {
            metaInfo[key] = `[Array(${value.length})]`;
          } else {
            metaInfo[key] = '[Object]';
          }
        } else {
          // 문자열이 너무 길면 잘라서 표시
          const strValue = value.toString();
          metaInfo[key] = strValue.length > 50 ? strValue.substring(0, 47) + '...' : strValue;
        }
      });

      if (Object.keys(metaInfo).length > 0) {
        logger.info('메타 정보:');
        console.table(metaInfo);
      }
    }

    // 오류 정보가 있으면 표시
    if (this.error) {
      logger.error('오류 정보:', this.error);
    }

    // 텍스트 내용이 있으면 일부 표시
    if (this.text) {
      const textLength = this.text.length;
      const previewText = textLength > 200 ? this.text.substring(0, 197) + '...' : this.text;

      logger.info(`텍스트 내용 (${textLength} 글자):`);
      logger.info(previewText);
    }

  } catch (error) {
    if (logger) {
      logger.error('URL 항목 요약 정보 생성 중 오류 발생:', error);
    } else {
      console.error('URL 항목 요약 정보 생성 중 오류 발생:', error);
    }
  }
};
// 메인 VisitResult 스키마 (도메인 기반)
const VisitResultSchema = new Schema({
  domain: {
    type: String,
    required: true,
    unique: true,
    index: true
  },
  suburl_list: [SubUrlSchema], // 주의: 필드명이 suburl_list임 (suburlList가 아님)
  created_at: {
    type: Date,
    default: Date.now
  },
  updated_at: {
    type: Date,
    default: Date.now
  },
  url: String
}, {
  timestamps: {
    createdAt: 'created_at',
    updatedAt: 'updated_at'
  },
  collection: 'domains'
});

// URL로 검색하는 static 메서드 추가
VisitResultSchema.statics.findByUrl = async function(url) {
  const domain = extractDomain(url);
  const result = await this.findOne({ domain });

  if (!result || !result.suburl_list) return null;

  // suburl_list 내에서 URL 검색
  const urlEntry = result.suburl_list.find(item => item.url === url);
  if (!urlEntry) return null;

  // URL 항목을 포함한 전체 결과 반환
  return {
    domain: result.domain,
    urlEntry
  };
};

// 방문하지 않은 URL 찾기
VisitResultSchema.statics.findUnvisitedUrl = async function(domain) {
  try {
    const result = await this.findOne({ domain });

    if (!result || !result.suburl_list) return null;

    // suburl_list 내에서 방문하지 않은 URL 찾기
    const unvisitedEntry = result.suburl_list.find(item => !item.visited);
    if (!unvisitedEntry) return null;

    return {
      url: unvisitedEntry.url,
      domain
    };
  } catch (error) {
    console.error(`도메인 ${domain}에서 방문하지 않은 URL 찾기 오류:`, error);
    return null;
  }
};

// 도메인 통계 가져오기
VisitResultSchema.statics.getDomainStatsEfficient = async function(logger) {
  try {
    // 모든 도메인 문서 가져오기
    const domains = await this.find({}).lean();

    // 도메인별 통계 계산
    const domainStats = domains.map(domain => {
      // 각 도메인의 URL 통계 계산
      const total = domain.suburl_list ? domain.suburl_list.length : 0;
      const visited = domain.suburl_list ? domain.suburl_list.filter(url => url.visited).length : 0;
      const pending = total - visited;

      return {
        domain: domain.domain,
        total,
        visited,
        pending
      };
    });

    // 전체 요약 통계 계산
    const summary = {
      totalDomains: domainStats.length,
      activeDomains: domainStats.filter(d => d.total > 0).length,
      totalUrls: domainStats.reduce((sum, d) => sum + d.total, 0),
      visitedUrls: domainStats.reduce((sum, d) => sum + d.visited, 0),
      pendingUrls: domainStats.reduce((sum, d) => sum + d.pending, 0)
    };

    if (logger) {
      logger.info(`도메인 통계: 총 ${summary.totalDomains}개 도메인, ${summary.totalUrls}개 URL (방문: ${summary.visitedUrls}, 대기: ${summary.pendingUrls})`);
    }

    return { domains: domainStats, summary };
  } catch (error) {
    if (logger) {
      logger.error('도메인 통계 계산 오류:', error);
    } else {
      console.error('도메인 통계 계산 오류:', error);
    }
    return { domains: [], summary: { totalDomains: 0, activeDomains: 0, totalUrls: 0, visitedUrls: 0, pendingUrls: 0 } };
  }
};


// 도메인 추출 헬퍼 함수
function extractDomain(url) {
  try {
    if (!url) return null;
    const hostname = new URL(url).hostname;
    return hostname;
  } catch (e) {
    console.error(`URL에서 도메인 추출 실패: ${url}`, e);
    return null;
  }
}



const SubUrl = mongoose.model('SubUrl', SubUrlSchema);


const VisitResult = mongoose.model('VisitResult', VisitResultSchema);

module.exports = {
  VisitResult,
  VisitResultSchema,
  SubUrl,
  SubUrlSchema,
  extractDomain
};</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.4</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
