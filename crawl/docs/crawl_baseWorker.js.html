<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>crawl/baseWorker.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BaseWorkerManager.html">BaseWorkerManager</a><ul class='methods'><li data-type='method'><a href="BaseWorkerManager.html#closeBrowser">closeBrowser</a></li><li data-type='method'><a href="BaseWorkerManager.html#connect">connect</a></li><li data-type='method'><a href="BaseWorkerManager.html#disconnect">disconnect</a></li><li data-type='method'><a href="BaseWorkerManager.html#extractLinks">extractLinks</a></li><li data-type='method'><a href="BaseWorkerManager.html#extractPageContent">extractPageContent</a></li><li data-type='method'><a href="BaseWorkerManager.html#filterAllowedUrls">filterAllowedUrls</a></li><li data-type='method'><a href="BaseWorkerManager.html#getNextUrl">getNextUrl</a></li><li data-type='method'><a href="BaseWorkerManager.html#getUrlForDomain">getUrlForDomain</a></li><li data-type='method'><a href="BaseWorkerManager.html#groupUrlsByDomain">groupUrlsByDomain</a></li><li data-type='method'><a href="BaseWorkerManager.html#handleDomainError">handleDomainError</a></li><li data-type='method'><a href="BaseWorkerManager.html#initAvailableDomains">initAvailableDomains</a></li><li data-type='method'><a href="BaseWorkerManager.html#initBrowser">initBrowser</a></li><li data-type='method'><a href="BaseWorkerManager.html#processQueue">processQueue</a></li><li data-type='method'><a href="BaseWorkerManager.html#run">run</a></li><li data-type='method'><a href="BaseWorkerManager.html#saveErrorScreenshot">saveErrorScreenshot</a></li><li data-type='method'><a href="BaseWorkerManager.html#saveVisitResult">saveVisitResult</a></li><li data-type='method'><a href="BaseWorkerManager.html#selectTargetDomain">selectTargetDomain</a></li><li data-type='method'><a href="BaseWorkerManager.html#tryNextDomain">tryNextDomain</a></li><li data-type='method'><a href="BaseWorkerManager.html#visitUrl">visitUrl</a></li></ul></li><li><a href="ClaudeParser.html">ClaudeParser</a><ul class='methods'><li data-type='method'><a href="ClaudeParser.html#connect">connect</a></li><li data-type='method'><a href="ClaudeParser.html#convertToRecruitInfoSchema">convertToRecruitInfoSchema</a></li><li data-type='method'><a href="ClaudeParser.html#fetchRecruitUrls">fetchRecruitUrls</a></li><li data-type='method'><a href="ClaudeParser.html#processUrl">processUrl</a></li><li data-type='method'><a href="ClaudeParser.html#requestUrlParse">requestUrlParse</a></li><li data-type='method'><a href="ClaudeParser.html#run">run</a></li><li data-type='method'><a href="ClaudeParser.html#saveRecruitInfo">saveRecruitInfo</a></li><li data-type='method'><a href="ClaudeParser.html#wait">wait</a></li></ul></li><li><a href="ClaudeService.html">ClaudeService</a><ul class='methods'><li data-type='method'><a href="ClaudeService.html#generateContent">generateContent</a></li><li data-type='method'><a href="ClaudeService.html#getRecruitmentPrompt">getRecruitmentPrompt</a></li><li data-type='method'><a href="ClaudeService.html#getStatus">getStatus</a></li><li data-type='method'><a href="ClaudeService.html#initializeClient">initializeClient</a></li></ul></li><li><a href="GeminiService.html">GeminiService</a><ul class='methods'><li data-type='method'><a href="GeminiService.html#generateContent">generateContent</a></li><li data-type='method'><a href="GeminiService.html#getKeyStatus">getKeyStatus</a></li><li data-type='method'><a href="GeminiService.html#getRecruitmentPrompt">getRecruitmentPrompt</a></li><li data-type='method'><a href="GeminiService.html#getRecruitmentSchema">getRecruitmentSchema</a></li><li data-type='method'><a href="GeminiService.html#initializeClient">initializeClient</a></li><li data-type='method'><a href="GeminiService.html#parseRecruitment">parseRecruitment</a></li><li data-type='method'><a href="GeminiService.html#rotateApiKey">rotateApiKey</a></li></ul></li><li><a href="Logger.html">Logger</a><ul class='methods'><li data-type='method'><a href="Logger.html#checkLogFileDate">checkLogFileDate</a></li><li data-type='method'><a href="Logger.html#colorize">colorize</a></li><li data-type='method'><a href="Logger.html#formatJsonMessage">formatJsonMessage</a></li><li data-type='method'><a href="Logger.html#formatJsonMessage">formatJsonMessage</a></li><li data-type='method'><a href="Logger.html#formatTextMessage">formatTextMessage</a></li><li data-type='method'><a href="Logger.html#log">log</a></li><li data-type='method'><a href="Logger.html#logEvent">logEvent</a></li><li data-type='method'><a href="Logger.html#setupLogFiles">setupLogFiles</a></li><li data-type='method'><a href="Logger.html#setupLogRotation">setupLogRotation</a></li></ul></li><li><a href="MongoDBService.html">MongoDBService</a><ul class='methods'><li data-type='method'><a href="MongoDBService.html#connect">connect</a></li><li data-type='method'><a href="MongoDBService.html#disconnect">disconnect</a></li><li data-type='method'><a href="MongoDBService.html#getConnection">getConnection</a></li><li data-type='method'><a href="MongoDBService.html#getConnectionStatus">getConnectionStatus</a></li><li data-type='method'><a href="MongoDBService.html#getMongoose">getMongoose</a></li><li data-type='method'><a href="MongoDBService.html#setDbName">setDbName</a></li><li data-type='method'><a href="MongoDBService.html#setUri">setUri</a></li></ul></li><li><a href="OnClickWorker.html">OnClickWorker</a><ul class='methods'><li data-type='method'><a href="OnClickWorker.html#checkUrlChanges">checkUrlChanges</a></li><li data-type='method'><a href="OnClickWorker.html#cleanup">cleanup</a></li><li data-type='method'><a href="OnClickWorker.html#execute">execute</a></li><li data-type='method'><a href="OnClickWorker.html#formatResult">formatResult</a></li><li data-type='method'><a href="OnClickWorker.html#initialize">initialize</a></li><li data-type='method'><a href="OnClickWorker.html#scrollFullPage">scrollFullPage</a></li><li data-type='method'><a href="OnClickWorker.html#scrollPage">scrollPage</a></li><li data-type='method'><a href="OnClickWorker.html#setupPage">setupPage</a></li></ul></li><li><a href="ParseManager.html">ParseManager</a><ul class='methods'><li data-type='method'><a href="ParseManager.html#cancel">cancel</a></li><li data-type='method'><a href="ParseManager.html#connect">connect</a></li><li data-type='method'><a href="ParseManager.html#convertToRecruitInfoSchema">convertToRecruitInfoSchema</a></li><li data-type='method'><a href="ParseManager.html#fetchUnclassifiedUrls">fetchUnclassifiedUrls</a></li><li data-type='method'><a href="ParseManager.html#getStatus">getStatus</a></li><li data-type='method'><a href="ParseManager.html#processUrl">processUrl</a></li><li data-type='method'><a href="ParseManager.html#requestUrlParse">requestUrlParse</a></li><li data-type='method'><a href="ParseManager.html#run">run</a></li><li data-type='method'><a href="ParseManager.html#saveRecruitInfo">saveRecruitInfo</a></li><li data-type='method'><a href="ParseManager.html#wait">wait</a></li></ul></li><li><a href="RecruitInfoDbService.html">RecruitInfoDbService</a><ul class='methods'><li data-type='method'><a href="RecruitInfoDbService.html#bulkCreateOrUpdate">bulkCreateOrUpdate</a></li><li data-type='method'><a href="RecruitInfoDbService.html#bulkDelete">bulkDelete</a></li><li data-type='method'><a href="RecruitInfoDbService.html#createOrUpdate">createOrUpdate</a></li><li data-type='method'><a href="RecruitInfoDbService.html#deleteByUrl">deleteByUrl</a></li><li data-type='method'><a href="RecruitInfoDbService.html#deleteExpired">deleteExpired</a></li><li data-type='method'><a href="RecruitInfoDbService.html#getAll">getAll</a></li><li data-type='method'><a href="RecruitInfoDbService.html#getByUrl">getByUrl</a></li><li data-type='method'><a href="RecruitInfoDbService.html#getStats">getStats</a></li><li data-type='method'><a href="RecruitInfoDbService.html#search">search</a></li><li data-type='method'><a href="RecruitInfoDbService.html#searchByKeywords">searchByKeywords</a></li></ul></li><li><a href="WorkerPool.html">WorkerPool</a><ul class='methods'><li data-type='method'><a href="WorkerPool.html#enqueue">enqueue</a></li><li data-type='method'><a href="WorkerPool.html#processQueue">processQueue</a></li><li data-type='method'><a href="WorkerPool.html#processTasks">processTasks</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#RecruitInfo">RecruitInfo</a></li><li><a href="global.html#createTableIfNotExists">createTableIfNotExists</a></li><li><a href="global.html#extractAndExecuteScripts">extractAndExecuteScripts</a></li><li><a href="global.html#extractAndProcessOnClicks">extractAndProcessOnClicks</a></li><li><a href="global.html#extractDomain">extractDomain</a></li><li><a href="global.html#getClaudeJobById">getClaudeJobById</a></li><li><a href="global.html#getClaudeJobFilters">getClaudeJobFilters</a></li><li><a href="global.html#getClaudeJobStats">getClaudeJobStats</a></li><li><a href="global.html#getClaudeJobs">getClaudeJobs</a></li><li><a href="global.html#getCompleteClaudeJobs">getCompleteClaudeJobs</a></li><li><a href="global.html#getCompletionStats">getCompletionStats</a></li><li><a href="global.html#getDomainStats">getDomainStats</a></li><li><a href="global.html#getExperienceStats">getExperienceStats</a></li><li><a href="global.html#getFailedVisitStats">getFailedVisitStats</a></li><li><a href="global.html#getJobById">getJobById</a></li><li><a href="global.html#getJobTypeStats">getJobTypeStats</a></li><li><a href="global.html#getJobs">getJobs</a></li><li><a href="global.html#getMySqlJobFilters">getMySqlJobFilters</a></li><li><a href="global.html#getMySqlJobs">getMySqlJobs</a></li><li><a href="global.html#getResults">getResults</a></li><li><a href="global.html#getStats">getStats</a></li><li><a href="global.html#getUrlDetails">getUrlDetails</a></li><li><a href="global.html#getUrlSeed">getUrlSeed</a></li><li><a href="global.html#getUrlStats">getUrlStats</a></li><li><a href="global.html#handler">handler</a></li><li><a href="global.html#infiniteScroll">infiniteScroll</a></li><li><a href="global.html#isUrlAllowed">isUrlAllowed</a></li><li><a href="global.html#isUrlAllowedWithRobots">isUrlAllowedWithRobots</a></li><li><a href="global.html#logProgress">logProgress</a></li><li><a href="global.html#main">main</a></li><li><a href="global.html#parseRobotsTxt">parseRobotsTxt</a></li><li><a href="global.html#processOnClickEvents">processOnClickEvents</a></li><li><a href="global.html#processOnclick">processOnclick</a></li><li><a href="global.html#resetFailedVisitsForDomain">resetFailedVisitsForDomain</a></li><li><a href="global.html#resetVisitedStatus">resetVisitedStatus</a></li><li><a href="global.html#resetVisitedStatusForDomain">resetVisitedStatusForDomain</a></li><li><a href="global.html#runCrawler">runCrawler</a></li><li><a href="global.html#saveJobToMySql">saveJobToMySql</a></li><li><a href="global.html#saveSeedsToMongoDB">saveSeedsToMongoDB</a></li><li><a href="global.html#scrollToBottom">scrollToBottom</a></li><li><a href="global.html#updateVisitResultDomains">updateVisitResultDomains</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">crawl/baseWorker.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const puppeteer = require('puppeteer');
const fs = require('fs');
const { extractAndProcessOnClicks } = require('@crawl/baseOnclick');
const { defaultLogger: logger } = require('@utils/logger');
const { isUrlAllowed, extractDomain } = require('@crawl/urlManager');
const CONFIG = require('@config/config');
const { executablePath } = require('puppeteer');

/**
 * 페이지를 아래로 스크롤하는 함수
 * @param {Page} page Puppeteer 페이지 객체
 * @returns {Promise&lt;number>} 스크롤 거리
 */
async function scrollToBottom(page) {
  return page.evaluate(async () => {
    const previousHeight = window.scrollY;
    window.scrollTo(0, document.body.scrollHeight);

    // 스크롤 변화가 있을 때까지 대기
    await new Promise(resolve => setTimeout(resolve, 1000));

    return document.body.scrollHeight;
  });
}

/**
 * 페이지를 무한 스크롤하는 함수
 * @param {Page} page Puppeteer 페이지 객체
 * @param {number} maxScrolls 최대 스크롤 수 (기본값: 20)
 * @returns {Promise&lt;number>} 실행된 스크롤 수
 */
async function infiniteScroll(page, maxScrolls = 5) {
  let previousHeight = 0;
  let currentHeight = await page.evaluate(() => document.body.scrollHeight);
  let scrollCount = 0;

  while (scrollCount &lt; maxScrolls) {
    previousHeight = currentHeight;
    currentHeight = await scrollToBottom(page);
    scrollCount++;
    logger.debug(`스크롤 ${scrollCount}/${maxScrolls} 수행 중... (높이: ${previousHeight} → ${currentHeight})`);
  }
  return scrollCount;
}


/**
 * 자바스크립트를 추출하고 실행하여 URL 추출
 * @param {string} url - 대상 URL
 * @param {Array&lt;string>} allowedDomains - 허용된 도메인 목록
 * @param {Browser} browser - 브라우저 인스턴스
 * @returns {Promise&lt;Array&lt;string>>} 추출된 URL 목록
 */
async function extractAndExecuteScripts(url, allowedDomains = [], browser) {
  const startTime = Date.now();
  logger.debug(`URL ${url}에서 자바스크립트 이벤트 핸들러 추출 중...`);

  try {
    // 새 페이지 열기
    const page = await browser.newPage();

    // JavaScript 대화 상자 무시
    page.on('dialog', async dialog => {
      await dialog.dismiss();
    });

    // 페이지 로드
    await page.goto(url, {
      waitUntil: 'networkidle2',
      timeout: CONFIG.BROWSER.TIMEOUT.PAGE_LOAD
    });

    // onClick 이벤트 핸들러 추출 및 실행
    const processStartTime = Date.now();
    const extractedUrls = await processOnclick(page, url, allowedDomains);
    const processRuntime = Date.now() - processStartTime;
    logger.eventInfo('process_onclick', { url, runtime: processRuntime });

    // 추출된 URL 및 페이지 정리
    await page.close();

    const runtime = Date.now() - startTime;
    logger.debug(`자바스크립트 처리 완료. 추출된 URL: ${extractedUrls.length}개`);

    return extractedUrls;
  } catch (error) {
    logger.error(`자바스크립트 처리 중 오류:`, error);
    const runtime = Date.now() - startTime;
    return [];
  }
}

/**
 * onClick 이벤트 핸들러를 처리하여 URL 추출
 * @param {Page} page - Puppeteer 페이지 객체
 * @param {string} baseUrl - 기준 URL
 * @param {Array&lt;string>} allowedDomains - 허용된 도메인 목록
 * @returns {Promise&lt;Array&lt;string>>} 추출된 URL 목록
 */
async function processOnclick(page, baseUrl, allowedDomains = []) {
  const startTime = Date.now();

  try {
    // 페이지 내의 모든 클릭 가능한 요소에서 URL 추출
    const extractedUrls = await page.evaluate((baseUrl) => {
      const results = [];
      // 클릭 이벤트를 가질 수 있는 모든 요소 수집
      const clickableElements = Array.from(document.querySelectorAll(
        'a[onclick], button, input[type="button"], input[type="submit"], [role="button"], [onclick]'
      ));

      // 현재 문서의 URL 객체
      const currentUrl = new URL(baseUrl);
      const baseOrigin = currentUrl.origin;

      // 각 요소에 클릭 이벤트 발생시키기
      clickableElements.forEach(element => {
        try {
          // 안전하게 클릭 이벤트 발생
          // 직접적인 onclick 속성 분석
          const onclickAttr = element.getAttribute('onclick');
          if (onclickAttr) {
            // href 또는 location.href 패턴 찾기
            const hrefMatches = onclickAttr.match(/(?:href|location\.href|window\.location)\s*=\s*['"]([^'"]+)['"]/i);
            if (hrefMatches &amp;&amp; hrefMatches[1]) {
              let url = hrefMatches[1];

              // 상대 URL 처리
              if (url.startsWith('/')) {
                url = `${baseOrigin}${url}`;
              } else if (!url.startsWith('http://') &amp;&amp; !url.startsWith('https://')) {
                const urlObj = new URL(url, baseUrl);
                url = urlObj.href;
              }

              results.push(url);
            }
          }

          // 기본 속성에서 URL 추출 시도
          if (element.hasAttribute('href')) {
            const href = element.getAttribute('href');
            if (href &amp;&amp; !href.startsWith('#') &amp;&amp; !href.startsWith('javascript:')) {
              let url;
              try {
                url = new URL(href, baseUrl).href;
                results.push(url);
              } catch (e) {
                // URL 생성 오류 - 잘못된 형식일 수 있음
              }
            }
          }
        } catch (elementError) {
          // 요소별 오류 처리 - 조용히 넘어감
        }
      });

      return Array.from(new Set(results)); // 중복 제거
    }, baseUrl);

    // 중복 제거 및 허용된 도메인만 필터링
    const uniqueUrls = [...new Set(extractedUrls)];
    const filteredUrls = uniqueUrls.filter(url => {
      try {
        return isUrlAllowed(url, allowedDomains);
      } catch (e) {
        return false;
      }
    });

    const runtime = Date.now() - startTime;
    logger.debug(`onClick 이벤트 처리 완료. ${filteredUrls.length}개 URL 추출됨.`);

    return filteredUrls;
  } catch (error) {
    logger.error(`onClick 이벤트 처리 중 오류:`, error);
    return [];
  }
}

// Promise 형식의 확장 함수
function extractAndExecuteScriptsPromise(url, allowedDomains = []) {
  return new Promise(async (resolve, reject) => {
    try {
      logger.debug(`독립 프로세스에서 URL ${url} 처리 중...`);

      // Puppeteer 브라우저 초기화
      const puppeteer = require('puppeteer');
      const browser = await puppeteer.launch({
        executablePath: await executablePath(),
        headless: 'new',
        args: CONFIG.BROWSER.LAUNCH_ARGS
      });

      try {
        // extractAndExecuteScripts 함수 사용
        const urls = await extractAndExecuteScripts(url, allowedDomains, browser);
        resolve(urls);
      } catch (error) {
        reject(error);
      } finally {
        await browser.close();
      }
    } catch (error) {
      reject(error);
    }
  });
}

// 모듈로 내보내기
module.exports = {
  scrollToBottom,
  infiniteScroll,
  extractAndExecuteScripts,
  extractAndExecuteScriptsPromise,
  processOnclick
};</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.4</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
